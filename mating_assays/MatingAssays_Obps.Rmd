---
title: "Obp R analyses"
author: "Nora C Brown, Benjamin Gordon, Caitlin E. McDonough-Goldstein, Snigdha Misra, Geoffrey D. Findlay, Andrew G. Clark, Mariana F. Wolfner"
output: html_document
---

This is an R markdown document that contains all code to analyze the data published in "The seminal odorant binding protein Obp56g is required in mating plug formation and male fertility in Drosophila melanogaster" 

##Obp56g deficiency assays
Definition of variables:
rep: replicate of experiment
vial: number of vial female placed in
male_geno: genotype of male CS female mated to
intro: time male introduced to vial
time_start: time flies began copulating
time_stop: time flies finished copulating
d_1 through d_4: number of eggs female laid on days 1-4
e_tot: sum of eggs in d_1 through d_4
mated: Y/N if that female mated with a CS male on the fourth day after mating within a one hour time frame
p_1 through p_4: number of pupae in vials days 1-4
p_tot: sum of pupae in p_1 through p_4
hatch_t: total hatchability, p_t/d_t
h_1 through h_4: hatchabillity of eggs on days 1-4, calculated as ex: p_1/d_1
lat: latency to mate, calculated as time_start-intro (note: not measured for replicate 1)
dur: duration of mating, calculated as time_stop-time_start

```{r}
#load packages needed from library
library(ggplot2)
library(dplyr)
library(tidyverse)
library(lme4)
library(rstatix)
library(chron)
library(emmeans)
library(nationalparkcolors)
library(tidyr)
```


```{r}
#import data
df2r_data = read.csv("Df2R_data.csv")

df2r_data$male_geno <- factor(df2r_data$male_geno, levels = c("Df/WT", "WT/CyO", "Obp56g/CyO", "Obp56g/Df"))

#subset replicates
rep1df = subset(df2r_data, df2r_data$rep == "1")
rep2df = subset(df2r_data, df2r_data$rep == "2")
```

```{r}
##replicate one
#get data in "long form" for graphing egg by day
rep1df_egg = rep1df %>%
  pivot_longer(cols = starts_with("d_"),
   names_to = "day",
   names_prefix = "d_",
   values_to = "eggs",
   values_drop_na = TRUE)

plot = ggplot(data=rep1df_egg, 
       aes(x=male_geno, 
           y=eggs, color=male_geno, fill=male_geno)) + 
  geom_dotplot(binaxis='y', stackdir = 'center', dotsize=0.6, position=position_dodge(1), alpha = 0.75) + 
  facet_grid(. ~ day, scales="free_x", space='free_x', labeller=label_both) +
  labs(x="Male Genotype", y="Eggs Laid")+
  theme_classic()+
  expand_limits(x = 1, y=80) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  theme(panel.spacing = unit(1, "lines")) + 
  theme(strip.text.x = element_text(colour = "black")) +
  theme(strip.background = element_blank()) 
  geom_jitter(position=position_dodge(1))

p = plot + stat_summary(fun.data=mean_se, fun.args = list(mult=1), 
                 geom="errorbar", position=position_dodge(1), color="gray48", width=0.05, size=0.4) + stat_summary(fun.y=mean, geom="point", color="gray48", position=position_dodge(1)) + theme(panel.spacing = unit(2, "lines")) 

p

#linear model egg lay
model1 = glmer(eggs ~ male_geno + day + (1|vial), family=poisson, data=rep1df_egg)
summary(model1)
model2 = glmer(eggs ~ day + (1|vial), family=poisson, data=rep1df_egg)
summary(model2)
anova(model2, model1)

#emmeans to compare marginal means, add male_geno*day interaction term
model3 = glmer(eggs ~ male_geno*day + (1|vial), family=poisson, data=rep1df_egg)
emmeans(model3, pairwise ~ male_geno | day)
```

```{r}
#hatchability rep 1
#pivot longer
rep1df_hatch = rep1df %>%
  pivot_longer(cols = starts_with("h_"),
   names_to = "day",
   names_prefix = "h_",
   values_to = "hatch",
   values_drop_na = TRUE)

plot = ggplot(data=rep1df_hatch, 
       aes(x=male_geno, 
           y=hatch, 
           fill=male_geno)) + 
  geom_boxplot() +
  geom_dotplot(binaxis='y', stackdir = 'center', dotsize=0.45, fill="black") + 
  facet_grid(. ~ day) +
  labs(x="Male Genotype", y="Egg Hatchability")+
  theme_bw()+
  theme(axis.title.y = element_text(size=18), axis.title.x = element_text(size=18), axis.text.y  = element_text(size=18),
           axis.text.x  = element_text(size=18), strip.text.x = element_text(size = 20))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  guides(fill=F)

plot

#linear model hatchability
model4 = glmer(p_tot/e_tot ~ male_geno + day + (1|vial), family=binomial, weights=e_tot, data=rep1df_hatch)
summary(model4)
model5 = glmer(p_tot/e_tot ~ day + (1|vial), family=binomial, weights=e_tot, data=rep1df_hatch)
summary(model5)
anova(model4, model5)

#emmeans to compare estimated marginal means, add male_geno*day interaction term
model6 = glmer(p_tot/e_tot ~ male_geno*day + (1|vial), family=binomial, weights=e_tot, data=rep1df_hatch)
emmeans(model6, pairwise ~ male_geno | day)
```

```{r}
#receptivity rep1
#make proportion table to see proportion of females that remated @ 4 days. 
table1 = table(rep1df$mated, rep1df$male_geno)
table1
prop_table1 = prop.table(table(rep1df$mated, rep1df$male_geno), 2)
prop_table1

#transform to percent
prop1 = apply(prop_table1, 2, function(x){x*100})
prop1

table2 = table(rep1df$male_geno, rep1df$mated)
table2

prop_table2 = prop.table(table(rep1df$male_geno, rep1df$mated), 1)
prop_table2

prop2 = apply(prop_table2, 2, function(x){x*100})
prop2

plot2 = barplot(prop1, col=c("indianred2", "lightblue"), xlab="Male Genotype", ylim=c(0,100), ylab="Female Remating Rate (%)", legend=rownames(prop1))
plot2
```

```{r}
#mating duration rep1
#did not measure latency in rep1
duration2 = 60*24*(as.numeric(times(rep1df$dur)))
rep1df = cbind(rep1df, duration2)

res.aov <- aov(duration2 ~ male_geno, data = rep1df)
# Summary of the analysis and post hoc tukey
summary(res.aov)
TukeyHSD(res.aov)
```

```{r}
##replicate two
#get data in "long form" for graphing egg by day
rep2df_egg = rep2df %>%
  pivot_longer(cols = starts_with("d_"),
   names_to = "day",
   names_prefix = "d_",
   values_to = "eggs",
   values_drop_na = TRUE)

plot = ggplot(data=rep2df_egg, 
       aes(x=male_geno, 
           y=eggs, color=male_geno, fill=male_geno)) + 
  geom_dotplot(binaxis='y', stackdir = 'center', dotsize=0.6, position=position_dodge(1), alpha = 0.75) + 
  facet_grid(. ~ day, scales="free_x", space='free_x', labeller=label_both) +
  labs(x="Male Genotype", y="Eggs Laid")+
  theme_classic()+
  expand_limits(x = 1, y=80) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  theme(panel.spacing = unit(1, "lines")) + 
  theme(strip.text.x = element_text(colour = "black")) +
  theme(strip.background = element_blank()) 
  geom_jitter(position=position_dodge(1))

p = plot + stat_summary(fun.data=mean_se, fun.args = list(mult=1), 
                 geom="errorbar", position=position_dodge(1), color="gray48", width=0.05, size=0.4) + stat_summary(fun.y=mean, geom="point", color="gray48", position=position_dodge(1)) + theme(panel.spacing = unit(2, "lines")) 
  
p

#linear model egg lay
model1 = glmer(eggs ~ male_geno + day + (1|vial), family=poisson, data=rep2df_egg)
summary(model1)
model2 = glmer(eggs ~ day + (1|vial), family=poisson, data=rep2df_egg)
summary(model2)
anova(model2, model1)

#emmeans to compare marginal means, add male_geno*day interaction term
model3 = glmer(eggs ~ male_geno*day + (1|vial), family=poisson, data=rep2df_egg)
emmeans(model3, pairwise ~ male_geno | day)
```

```{r}
#hatchability rep 2
#pivot longer
rep2df_hatch = rep2df %>%
  pivot_longer(cols = starts_with("h_"),
   names_to = "day",
   names_prefix = "h_",
   values_to = "hatch",
   values_drop_na = TRUE)

plot = ggplot(data=rep2df_hatch, 
       aes(x=male_geno, 
           y=hatch, 
           fill=male_geno)) + 
  geom_boxplot() +
  geom_dotplot(binaxis='y', stackdir = 'center', dotsize=0.45, fill="black") + 
  facet_grid(. ~ day) +
  labs(x="Male Genotype", y="Egg Hatchability")+
  theme_bw()+
  theme(axis.title.y = element_text(size=18), axis.title.x = element_text(size=18), axis.text.y  = element_text(size=18),
           axis.text.x  = element_text(size=18), strip.text.x = element_text(size = 20))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  guides(fill=F)

plot

#linear model hatchability
model4 = glmer(p_tot/e_tot ~ male_geno + day + (1|vial), family=binomial, weights=e_tot, data=rep2df_hatch)
summary(model4)
model5 = glmer(p_tot/e_tot ~ day + (1|vial), family=binomial, weights=e_tot, data=rep2df_hatch)
summary(model5)
anova(model4, model5)

#emmeans to compare estimated marginal means, add male_geno*day interaction term
model6 = glmer(p_tot/e_tot ~ male_geno*day + (1|vial), family=binomial, weights=e_tot, data=rep2df_hatch)
emmeans(model6, pairwise ~ male_geno | day)
```

```{r}
#receptivity rep2 
#make proportion table to see proportion of females that remated @ 4 days. 
table1 = table(rep2df$mated, rep2df$male_geno)
table1
prop_table1 = prop.table(table(rep2df$mated, rep2df$male_geno), 2)
prop_table1

#transform to percent
prop1 = apply(prop_table1, 2, function(x){x*100})
prop1

table2 = table(rep2df$male_geno, rep2df$mated)
table2

prop_table2 = prop.table(table(rep2df$male_geno, rep2df$mated), 1)
prop_table2

prop2 = apply(prop_table2, 2, function(x){x*100})
prop2

plot2 = barplot(prop1, col=c("indianred2", "lightblue"), xlab="Male Genotype", ylim=c(0,100), ylab="Female Remating Rate (%)", legend=rownames(prop1))
plot2
```

```{r}
#mating latency and duration rep2
latency2 = 60*24*(as.numeric(times(rep2df$lat)))
rep2df = cbind(rep2df, latency2)
duration2 = 60*24*(as.numeric(times(rep2df$dur)))
rep2df = cbind(rep2df, duration2)

res.aov <- aov(latency2 ~ male_geno, data = rep2df)
# Summary of the analysis and post hoc tukey
summary(res.aov)
TukeyHSD(res.aov)

res.aov <- aov(duration2 ~ male_geno, data = rep2df)
# Summary of the analysis and post hoc tukey
summary(res.aov)
TukeyHSD(res.aov)
```

##CRISPR mating assays
Definition of variables:
vial: vial CS female is put into
replicate: replicate of experiment
gene: obp gene that is mutated
male_geno: genotype of male CS female is mated to, either CyO (control) or KO (experimental)--note this same notation is used for obp8a 
intro: time male introduced to vial
start: time flies began copulating
done: time flies finished copulating
lat: latency to mate, calculated as start-intro 
dur: duration of mating, calculated as done-start
d_1 through d_4: number of eggs female laid on days 1-4
e_tot: sum of eggs in d_1 through d_4
mated: Y/N if that female mated with a CS male on the fourth day after mating within a one hour time frame
p_1 through p_4: number of pupae in vials days 1-4
pup_t: sum of pupae in p_1 through p_4
h_1 through h_4: hatchabillity of eggs on days 1-4, calculated as ex: p_1/d_1
hatch_tot: total hatchability, pup_t/e_tot

```{r}
#replicate one
crispr_comb = read.csv("crispr_combined.csv")

#subset out the different replicates and genes
crispr_r1 = subset(crispr_comb, crispr_comb$rep == "1")
crispr_r2 = subset(crispr_comb, crispr_comb$rep == "2")

#rep1
obp56i_r1 = subset(crispr_r1, crispr_r1$gene == "56i")
obp51a_r1 = subset(crispr_r1, crispr_r1$gene == "51a")
obp56e_r1 = subset(crispr_r1, crispr_r1$gene == "56e")
obp22a_r1 = subset(crispr_r1, crispr_r1$gene == "22a")
obp56f_r1 = subset(crispr_r1, crispr_r1$gene == "56f")
obp8a_r1 = subset(crispr_r1, crispr_r1$gene == "8a")

#rep2
obp56i_r2 = subset(crispr_r2, crispr_r2$gene == "56i")
obp51a_r2 = subset(crispr_r2, crispr_r2$gene == "51a")
obp56e_r2 = subset(crispr_r2, crispr_r2$gene == "56e")
obp22a_r2 = subset(crispr_r2, crispr_r2$gene == "22a")
obp56f_r2 = subset(crispr_r2, crispr_r2$gene == "56f")
obp8a_r2 = subset(crispr_r2, crispr_r2$gene == "8a")
```

```{r}
#egg lay plotting totals rep1
plot = ggplot(data=crispr_r1, 
       aes(x=male_geno, 
           y=e_tot), 
           fill=male_geno) +
  geom_dotplot(binaxis='y', stackdir = 'center', dotsize=0.45, alpha = 0.9) + 
  facet_grid(. ~ gene) +
  labs(x="Male Genotype", y="Eggs laid (total)")+
  theme_classic()+
  theme(panel.spacing = unit(1, "lines")) + 
  theme(strip.text.x = element_text(colour = "black")) +
  theme(strip.background = element_blank())

p = plot + stat_summary(fun.data=mean_se, fun.args = list(mult=1), 
                 geom="errorbar", position=position_dodge(1), color="gray48", width=0.2, size=0.4) +      stat_summary(fun.y=mean, geom="point", color="gray48", position=position_dodge(1)) 

p

#egg hatch totals rep1
plot = ggplot(data=crispr_r1, 
       aes(x=male_geno, 
           y=hatch_tot), 
           fill=male_geno) +
  geom_dotplot(binaxis='y', stackdir = 'center', dotsize=0.45, alpha = 0.9) + 
  facet_grid(. ~ gene) +
  labs(x="Male Genotype", y="Total hatchability")+
  theme_classic()+
  theme(panel.spacing = unit(1, "lines")) + 
  theme(strip.text.x = element_text(colour = "black")) +
  theme(strip.background = element_blank())

p = plot + stat_summary(fun.data=mean_se, fun.args = list(mult=1), 
                 geom="errorbar", position=position_dodge(1), color="gray48", width=0.2, size=0.4) +      stat_summary(fun.y=mean, geom="point", color="gray48", position=position_dodge(1)) 

p

#egg lay plotting totals rep2
plot = ggplot(data=crispr_r2, 
       aes(x=male_geno, 
           y=e_tot), 
           fill=male_geno) +
  geom_dotplot(binaxis='y', stackdir = 'center', dotsize=0.45, alpha = 0.9) + 
  facet_grid(. ~ gene) +
  labs(x="Male Genotype", y="Eggs laid (total)")+
  theme_classic()+
  theme(panel.spacing = unit(1, "lines")) + 
  theme(strip.text.x = element_text(colour = "black")) +
  theme(strip.background = element_blank())

p = plot + stat_summary(fun.data=mean_se, fun.args = list(mult=1), 
                 geom="errorbar", position=position_dodge(1), color="gray48", width=0.2, size=0.4) +      stat_summary(fun.y=mean, geom="point", color="gray48", position=position_dodge(1)) 

p

#egg hatch totals rep2
plot = ggplot(data=crispr_r2, 
       aes(x=male_geno, 
           y=hatch_tot), 
           fill=male_geno) +
  geom_dotplot(binaxis='y', stackdir = 'center', dotsize=0.45, alpha = 0.9) + 
  facet_grid(. ~ gene) +
  labs(x="Male Genotype", y="Total hatchability")+
  theme_classic()+
  theme(panel.spacing = unit(1, "lines")) + 
  theme(strip.text.x = element_text(colour = "black")) +
  theme(strip.background = element_blank())

p = plot + stat_summary(fun.data=mean_se, fun.args = list(mult=1), 
                 geom="errorbar", position=position_dodge(1), color="gray48", width=0.2, size=0.4) +      stat_summary(fun.y=mean, geom="point", color="gray48", position=position_dodge(1)) 

p
```

```{r}
#get data into "long form" for linear models egg lay

#rep1
#obp56i
obp56i_r1_long = obp56i_r1 %>%
  pivot_longer(cols = starts_with("d_"),
   names_to = "day",
   names_prefix = "d_",
   values_to = "eggs",
   values_drop_na = TRUE)
obp56i_r1_long$day = as.factor(obp56i_r1_long$day)

#obp51a
obp51a_r1_long = obp51a_r1 %>%
  pivot_longer(cols = starts_with("d_"),
   names_to = "day",
   names_prefix = "d_",
   values_to = "eggs",
   values_drop_na = TRUE)
obp51a_r1_long$day = as.factor(obp51a_r1_long$day)

#obp56e
obp56e_r1_long = obp56e_r1 %>%
  pivot_longer(cols = starts_with("d_"),
   names_to = "day",
   names_prefix = "d_",
   values_to = "eggs",
   values_drop_na = TRUE)
obp56e_r1_long$day = as.factor(obp56e_r1_long$day)

#obp22a
obp22a_r1_long = obp22a_r1 %>%
  pivot_longer(cols = starts_with("d_"),
   names_to = "day",
   names_prefix = "d_",
   values_to = "eggs",
   values_drop_na = TRUE)
obp22a_r1_long$day = as.factor(obp22a_r1_long$day)

#obp56f
obp56f_r1_long = obp56f_r1 %>%
  pivot_longer(cols = starts_with("d_"),
   names_to = "day",
   names_prefix = "d_",
   values_to = "eggs",
   values_drop_na = TRUE)
obp56f_r1_long$day = as.factor(obp56f_r1_long$day)

#obp8a
obp8a_r1_long = obp8a_r1 %>%
  pivot_longer(cols = starts_with("d_"),
   names_to = "day",
   names_prefix = "d_",
   values_to = "eggs",
   values_drop_na = TRUE)
obp8a_r1_long$day = as.factor(obp8a_r1_long$day)

#rep2
#obp56i
obp56i_r2_long = obp56i_r2 %>%
  pivot_longer(cols = starts_with("d_"),
   names_to = "day",
   names_prefix = "d_",
   values_to = "eggs",
   values_drop_na = TRUE)
obp56i_r2_long$day = as.factor(obp56i_r2_long$day)

#obp51a
obp51a_r2_long = obp51a_r2 %>%
  pivot_longer(cols = starts_with("d_"),
   names_to = "day",
   names_prefix = "d_",
   values_to = "eggs",
   values_drop_na = TRUE)
obp51a_r2_long$day = as.factor(obp51a_r2_long$day)

#obp56e
obp56e_r2_long = obp56e_r2 %>%
  pivot_longer(cols = starts_with("d_"),
   names_to = "day",
   names_prefix = "d_",
   values_to = "eggs",
   values_drop_na = TRUE)
obp56e_r2_long$day = as.factor(obp56e_r2_long$day)

#obp22a
obp22a_r2_long = obp22a_r2 %>%
  pivot_longer(cols = starts_with("d_"),
   names_to = "day",
   names_prefix = "d_",
   values_to = "eggs",
   values_drop_na = TRUE)
obp22a_r2_long$day = as.factor(obp22a_r2_long$day)

#obp56f
obp56f_r2_long = obp56f_r2 %>%
  pivot_longer(cols = starts_with("d_"),
   names_to = "day",
   names_prefix = "d_",
   values_to = "eggs",
   values_drop_na = TRUE)
obp56f_r2_long$day = as.factor(obp56f_r2_long$day)

#obp8a
obp8a_r2_long = obp8a_r2 %>%
  pivot_longer(cols = starts_with("d_"),
   names_to = "day",
   names_prefix = "d_",
   values_to = "eggs",
   values_drop_na = TRUE)
obp8a_r2_long$day = as.factor(obp8a_r2_long$day)
```

```{r}
#linear models crispr egg lay rep1

#obp56i
model1 = glmer(eggs ~ male_geno + day + (1|vial), family=poisson, data=obp56i_r1_long)
summary(model1)
#extract p val for male genotype term and add to vector of p vals
p_56i=summary(model1)$coefficients[2,4]
pvals_egglay_r1=c(p_56i)
model2 = glmer(eggs ~ day + (1|vial), family=poisson, data=obp56i_r1_long)
summary(model2)
anova(model2, model1)

#obp51a
model1 = glmer(eggs ~ male_geno + day + (1|vial), family=poisson, data=obp51a_r1_long)
summary(model1)
#extract p val for male genotype term and add to vector of p vals
p_51a=summary(model1)$coefficients[2,4]
pvals_egglay_r1=append(pvals_egglay_r1, p_51a)
model2 = glmer(eggs ~ day + (1|vial), family=poisson, data=obp51a_r1_long)
summary(model2)
anova(model2, model1)

#obp56e
model1 = glmer(eggs ~ male_geno + day + (1|vial), family=poisson, data=obp56e_r1_long)
summary(model1)
#extract p val for male genotype term and add to vector of p vals
p_56e=summary(model1)$coefficients[2,4]
pvals_egglay_r1=append(pvals_egglay_r1, p_56e)
model2 = glmer(eggs ~ day + (1|vial), family=poisson, data=obp56e_r1_long)
summary(model2)
anova(model2, model1)

#obp22a
model1 = glmer(eggs ~ male_geno + day + (1|vial), family=poisson, data=obp22a_r1_long)
summary(model1)
#extract p val for male genotype term and add to vector of p vals
p_22a=summary(model1)$coefficients[2,4]
pvals_egglay_r1=append(pvals_egglay_r1, p_22a)
model2 = glmer(eggs ~ day + (1|vial), family=poisson, data=obp22a_r1_long)
summary(model2)
anova(model2, model1)

#obp56f
model1 = glmer(eggs ~ male_geno + day + (1|vial), family=poisson, data=obp56f_r1_long)
summary(model1)
#extract p val for male genotype term and add to vector of p vals
p_56f=summary(model1)$coefficients[2,4]
pvals_egglay_r1=append(pvals_egglay_r1, p_56f)
model2 = glmer(eggs ~ day + (1|vial), family=poisson, data=obp56f_r1_long)
summary(model2)
anova(model2, model1)

#obp8a
model1 = glmer(eggs ~ male_geno + day + (1|vial), family=poisson, data=obp8a_r1_long)
summary(model1)
#extract p val for male genotype term and add to vector of p vals
p_8a=summary(model1)$coefficients[2,4]
pvals_egglay_r1=append(pvals_egglay_r1, p_8a)
model2 = glmer(eggs ~ day + (1|vial), family=poisson, data=obp8a_r1_long)
summary(model2)
anova(model2, model1)

##linear models egg lay rep 2

#obp56i
model1 = glmer(eggs ~ male_geno + day + (1|vial), family=poisson, data=obp56i_r2_long)
summary(model1)
#extract p val for male genotype term and add to vector of p vals
p_56i_2=summary(model1)$coefficients[2,4]
pvals_egglay_r2=c(p_56i_2)
model2 = glmer(eggs ~ day + (1|vial), family=poisson, data=obp56i_r2_long)
summary(model2)
anova(model2, model1)

#obp51a
model1 = glmer(eggs ~ male_geno + day + (1|vial), family=poisson, data=obp51a_r2_long)
summary(model1)
#extract p val for male genotype term and add to vector of p vals
p_51a_2=summary(model1)$coefficients[2,4]
pvals_egglay_r2=append(pvals_egglay_r2, p_51a_2)
model2 = glmer(eggs ~ day + (1|vial), family=poisson, data=obp51a_r2_long)
summary(model2)
anova(model2, model1)

#obp56e
model1 = glmer(eggs ~ male_geno + day + (1|vial), family=poisson, data=obp56e_r2_long)
summary(model1)
#extract p val for male genotype term and add to vector of p vals
p_56e_2=summary(model1)$coefficients[2,4]
pvals_egglay_r2=append(pvals_egglay_r2, p_56e_2)
model2 = glmer(eggs ~ day + (1|vial), family=poisson, data=obp56e_r2_long)
summary(model2)
anova(model2, model1)

#obp22a
model1 = glmer(eggs ~ male_geno + day + (1|vial), family=poisson, data=obp22a_r2_long)
summary(model1)
#extract p val for male genotype term and add to vector of p vals
p_22a_2=summary(model1)$coefficients[2,4]
pvals_egglay_r2=append(pvals_egglay_r2, p_22a_2)
model2 = glmer(eggs ~ day + (1|vial), family=poisson, data=obp22a_r2_long)
summary(model2)
anova(model2, model1)

#obp56f
model1 = glmer(eggs ~ male_geno + day + (1|vial), family=poisson, data=obp56f_r2_long)
summary(model1)
#extract p val for male genotype term and add to vector of p vals
p_56f_2=summary(model1)$coefficients[2,4]
pvals_egglay_r2=append(pvals_egglay_r2, p_56f_2)
model2 = glmer(eggs ~ day + (1|vial), family=poisson, data=obp56f_r2_long)
summary(model2)
anova(model2, model1)

#obp8a
model1 = glmer(eggs ~ male_geno + day + (1|vial), family=poisson, data=obp8a_r2_long)
summary(model1)
#extract p val for male genotype term and add to vector of p vals
p_8a_2=summary(model1)$coefficients[2,4]
pvals_egglay_r2=append(pvals_egglay_r2, p_8a_2)
model2 = glmer(eggs ~ day + (1|vial), family=poisson, data=obp8a_r2_long)
summary(model2)
anova(model2, model1)

##perform BH correction on vector of p values
pvals_egglay_r1
pvals_egglay_r2

p.adjust(pvals_egglay_r1, "BH", 6)
p.adjust(pvals_egglay_r2, "BH", 6)
```

```{r}
#get data into "long form" for linear models hatch

#rep1
#obp56i
obp56i_r1_long = obp56i_r1 %>%
  pivot_longer(cols = starts_with("h_"),
   names_to = "day",
   names_prefix = "h_",
   values_to = "hatch",
   values_drop_na = TRUE)
obp56i_r1_long$day = as.factor(obp56i_r1_long$day)

#obp51a
obp51a_r1_long = obp51a_r1 %>%
  pivot_longer(cols = starts_with("h_"),
   names_to = "day",
   names_prefix = "h_",
   values_to = "hatch",
   values_drop_na = TRUE)
obp51a_r1_long$day = as.factor(obp51a_r1_long$day)

#obp56e
obp56e_r1_long = obp56e_r1 %>%
  pivot_longer(cols = starts_with("h_"),
   names_to = "day",
   names_prefix = "h_",
   values_to = "hatch",
   values_drop_na = TRUE)
obp56e_r1_long$day = as.factor(obp56e_r1_long$day)

#obp22a
obp22a_r1_long = obp22a_r1 %>%
  pivot_longer(cols = starts_with("h_"),
   names_to = "day",
   names_prefix = "h_",
   values_to = "hatch",
   values_drop_na = TRUE)
obp22a_r1_long$day = as.factor(obp22a_r1_long$day)

#obp56f
obp56f_r1_long = obp56f_r1 %>%
  pivot_longer(cols = starts_with("h_"),
   names_to = "day",
   names_prefix = "h_",
   values_to = "hatch",
   values_drop_na = TRUE)
obp56f_r1_long$day = as.factor(obp56f_r1_long$day)

#obp8a
obp8a_r1_long = obp8a_r1 %>%
  pivot_longer(cols = starts_with("h_"),
   names_to = "day",
   names_prefix = "h_",
   values_to = "hatch",
   values_drop_na = TRUE)
obp8a_r1_long$day = as.factor(obp8a_r1_long$day)

#rep2
#obp56i
obp56i_r2_long = obp56i_r2 %>%
  pivot_longer(cols = starts_with("h_"),
   names_to = "day",
   names_prefix = "h_",
   values_to = "hatch",
   values_drop_na = TRUE)
obp56i_r2_long$day = as.factor(obp56i_r2_long$day)

#obp51a
obp51a_r2_long = obp51a_r2 %>%
  pivot_longer(cols = starts_with("h_"),
   names_to = "day",
   names_prefix = "h_",
   values_to = "hatch",
   values_drop_na = TRUE)
obp51a_r2_long$day = as.factor(obp51a_r2_long$day)

#obp56e
obp56e_r2_long = obp56e_r2 %>%
  pivot_longer(cols = starts_with("h_"),
   names_to = "day",
   names_prefix = "h_",
   values_to = "hatch",
   values_drop_na = TRUE)
obp56e_r2_long$day = as.factor(obp56e_r2_long$day)

#obp22a
obp22a_r2_long = obp22a_r2 %>%
  pivot_longer(cols = starts_with("h_"),
   names_to = "day",
   names_prefix = "h_",
   values_to = "hatch",
   values_drop_na = TRUE)
obp22a_r2_long$day = as.factor(obp22a_r2_long$day)

#obp56f
obp56f_r2_long = obp56f_r2 %>%
  pivot_longer(cols = starts_with("h_"),
   names_to = "day",
   names_prefix = "h_",
   values_to = "hatch",
   values_drop_na = TRUE)
obp56f_r2_long$day = as.factor(obp56f_r2_long$day)

#obp8a
obp8a_r2_long = obp8a_r2 %>%
  pivot_longer(cols = starts_with("h_"),
   names_to = "day",
   names_prefix = "h_",
   values_to = "hatch",
   values_drop_na = TRUE)
obp8a_r2_long$day = as.factor(obp8a_r2_long$day)
```

```{r}
#linear models hatch rep1

#obp56i
model1 = glmer(pup_t/e_tot ~ male_geno + day + (1|vial), family=binomial, weights=e_tot, data=obp56i_r1_long)
summary(model1)
#extract p val for male genotype term and add to vector of p vals
p_hatch_56i=summary(model1)$coefficients[2,4]
pvals_hatch_r1=c(p_hatch_56i)

model2 = glmer(pup_t/e_tot ~ day + (1|vial), family=binomial, weights=e_tot, data=obp56i_r1_long)
summary(model2)
anova(model2, model1)

#obp51a
model1 = glmer(pup_t/e_tot ~ male_geno + day + (1|vial), family=binomial, weights=e_tot, data=obp51a_r1_long)
summary(model1)
#extract p val for male genotype term and add to vector of p vals
p_hatch_51a=summary(model1)$coefficients[2,4]
pvals_hatch_r1=append(pvals_hatch_r1, p_hatch_51a)

model2 = glmer(pup_t/e_tot ~ day + (1|vial), family=binomial, weights=e_tot, data=obp51a_r1_long)
summary(model2)
anova(model2, model1)

#obp56e
model1 = glmer(pup_t/e_tot ~ male_geno + day + (1|vial), family=binomial, weights=e_tot, data=obp56e_r1_long)
summary(model1)
#extract p val for male genotype term and add to vector of p vals
p_hatch_56e=summary(model1)$coefficients[2,4]
pvals_hatch_r1=append(pvals_hatch_r1, p_hatch_56e)

model2 = glmer(pup_t/e_tot ~ day + (1|vial), family=binomial, weights=e_tot, data=obp56e_r1_long)
summary(model2)
anova(model2, model1)

#obp22a
model1 = glmer(pup_t/e_tot ~ male_geno + day + (1|vial), family=binomial, weights=e_tot, data=obp22a_r1_long)
summary(model1)
#extract p val for male genotype term and add to vector of p vals
p_hatch_22a=summary(model1)$coefficients[2,4]
pvals_hatch_r1=append(pvals_hatch_r1, p_hatch_22a)

model2 = glmer(pup_t/e_tot ~ day + (1|vial), family=binomial, weights=e_tot, data=obp22a_r1_long)
summary(model2)
anova(model2, model1)

#obp56f
model1 = glmer(pup_t/e_tot ~ male_geno + day + (1|vial), family=binomial, weights=e_tot, data=obp56f_r1_long)
summary(model1)
#extract p val for male genotype term and add to vector of p vals
p_hatch_56f=summary(model1)$coefficients[2,4]
pvals_hatch_r1=append(pvals_hatch_r1, p_hatch_56f)

model2 = glmer(pup_t/e_tot ~ day + (1|vial), family=binomial, weights=e_tot, data=obp56f_r1_long)
summary(model2)
anova(model2, model1)

#obp8a
model1 = glmer(pup_t/e_tot ~ male_geno + day + (1|vial), family=binomial, weights=e_tot, data=obp8a_r1_long)
summary(model1)
#extract p val for male genotype term and add to vector of p vals
p_hatch_8a=summary(model1)$coefficients[2,4]
pvals_hatch_r1=append(pvals_hatch_r1, p_hatch_8a)

model2 = glmer(pup_t/e_tot ~ day + (1|vial), family=binomial, weights=e_tot, data=obp8a_r1_long)
summary(model2)
anova(model2, model1)

##linear models hatch rep 2

#obp56i
model1 = glmer(pup_t/e_tot ~ male_geno + day + (1|vial), family=binomial, weights=e_tot, data=obp56i_r2_long)
summary(model1)
#extract p val for male genotype term and add to vector of p vals
p_hatch_56i_2=summary(model1)$coefficients[2,4]
pvals_hatch_r2=c(p_hatch_56i_2)

model2 = glmer(pup_t/e_tot ~ day + (1|vial), family=binomial, weights=e_tot, data=obp56i_r2_long)
summary(model2)
anova(model2, model1)

#obp51a
model1 = glmer(pup_t/e_tot ~ male_geno + day + (1|vial), family=binomial, weights=e_tot, data=obp51a_r2_long)
summary(model1)
#extract p val for male genotype term and add to vector of p vals
p_hatch_51a_2=summary(model1)$coefficients[2,4]
pvals_hatch_r2=append(pvals_hatch_r2, p_hatch_51a_2)

model2 = glmer(pup_t/e_tot ~ day + (1|vial), family=binomial, weights=e_tot, data=obp51a_r2_long)
summary(model2)
anova(model2, model1)

#obp56e
model1 = glmer(pup_t/e_tot ~ male_geno + day + (1|vial), family=binomial, weights=e_tot, data=obp56e_r2_long)
summary(model1)
#extract p val for male genotype term and add to vector of p vals
p_hatch_56e_2=summary(model1)$coefficients[2,4]
pvals_hatch_r2=append(pvals_hatch_r2, p_hatch_56e_2)

model2 = glmer(pup_t/e_tot ~ day + (1|vial), family=binomial, weights=e_tot, data=obp56e_r2_long)
summary(model2)
anova(model2, model1)

#obp22a
model1 = glmer(pup_t/e_tot ~ male_geno + day + (1|vial), family=binomial, weights=e_tot, data=obp22a_r2_long)
summary(model1)
#extract p val for male genotype term and add to vector of p vals
p_hatch_22a_2=summary(model1)$coefficients[2,4]
pvals_hatch_r2=append(pvals_hatch_r2, p_hatch_22a_2)

model2 = glmer(pup_t/e_tot ~ day + (1|vial), family=binomial, weights=e_tot, data=obp22a_r2_long)
summary(model2)
anova(model2, model1)

#obp56f
model1 = glmer(pup_t/e_tot ~ male_geno + day + (1|vial), family=binomial, weights=e_tot, data=obp56f_r2_long)
summary(model1)
#extract p val for male genotype term and add to vector of p vals
p_hatch_56f_2=summary(model1)$coefficients[2,4]
pvals_hatch_r2=append(pvals_hatch_r2, p_hatch_56f_2)

model2 = glmer(pup_t/e_tot ~ day + (1|vial), family=binomial, weights=e_tot, data=obp56f_r2_long)
summary(model2)
anova(model2, model1)

#obp8a
model1 = glmer(pup_t/e_tot ~ male_geno + day + (1|vial), family=binomial, weights=e_tot, data=obp8a_r2_long)
summary(model1)
#extract p val for male genotype term and add to vector of p vals
p_hatch_8a_2=summary(model1)$coefficients[2,4]
pvals_hatch_r2=append(pvals_hatch_r2, p_hatch_8a_2)

model2 = glmer(pup_t/e_tot ~ day + (1|vial), family=binomial, weights=e_tot, data=obp8a_r2_long)
summary(model2)
anova(model2, model1)

##perform BH correction on vector of p values
p.adjust(pvals_hatch_r1, "BH", 6)
p.adjust(pvals_hatch_r2, "BH", 6)
```

```{r}
##receptivity crispr rep1 and graphs
#make proportion table to see proportion of females that remated @ 4 days. 
#obp56i
table1 = table(obp56i_r1$mated, obp56i_r1$male_geno)
table1
prop_table1 = prop.table(table(obp56i_r1$mated, obp56i_r1$male_geno), 2)
prop_table1

#transform to percent
prop1 = apply(prop_table1, 2, function(x){x*100})
prop1

fisher.test(table1)

#extract p val from fisher test and add it to vector of p vals
p_56i_remate_1=fisher.test(table1)$p.value
pvals_remating_1 = c(p_56i_remate_1)

#obp51a
table1 = table(obp51a_r1$mated, obp51a_r1$male_geno)
table1
prop_table1 = prop.table(table(obp51a_r1$mated, obp51a_r1$male_geno), 2)
prop_table1

#transform to percent
prop1 = apply(prop_table1, 2, function(x){x*100})
prop1

fisher.test(table1)

#extract p val from fisher test and add it to vector of p vals
p_51a_remate_1=fisher.test(table1)$p.value
pvals_remating_1 = append(pvals_remating_1, p_51a_remate_1)

#obp56e
table1 = table(obp56e_r1$mated, obp56e_r1$male_geno)
table1
prop_table1 = prop.table(table(obp56e_r1$mated, obp56e_r1$male_geno), 2)
prop_table1

#transform to percent
prop1 = apply(prop_table1, 2, function(x){x*100})
prop1

fisher.test(table1)

#extract p val from fisher test and add it to vector of p vals
p_56e_remate_1=fisher.test(table1)$p.value
pvals_remating_1 = append(pvals_remating_1, p_56e_remate_1)

##obp22a
table1 = table(obp22a_r1$mated, obp22a_r1$male_geno)
table1
prop_table1 = prop.table(table(obp22a_r1$mated, obp22a_r1$male_geno), 2)
prop_table1

#transform to percent
prop1 = apply(prop_table1, 2, function(x){x*100})
prop1

fisher.test(table1)

#extract p val from fisher test and add it to vector of p vals
p_22a_remate_1=fisher.test(table1)$p.value
pvals_remating_1 = append(pvals_remating_1, p_22a_remate_1)

#obp56f
table1 = table(obp56f_r1$mated, obp56f_r1$male_geno)
table1
prop_table1 = prop.table(table(obp56f_r1$mated, obp56f_r1$male_geno), 2)
prop_table1

#transform to percent
prop1 = apply(prop_table1, 2, function(x){x*100})
prop1

fisher.test(table1)

#extract p val from fisher test and add it to vector of p vals
p_56f_remate_1=fisher.test(table1)$p.value
pvals_remating_1 = append(pvals_remating_1, p_56f_remate_1)

#obp8a
table1 = table(obp8a_r1$mated, obp8a_r1$male_geno)
table1
prop_table1 = prop.table(table(obp8a_r1$mated, obp8a_r1$male_geno), 2)
prop_table1

#transform to percent
prop1 = apply(prop_table1, 2, function(x){x*100})
prop1

fisher.test(table1)

#extract p val from fisher test and add it to vector of p vals
p_8a_remate_1=fisher.test(table1)$p.value
pvals_remating_1 = append(pvals_remating_1, p_8a_remate_1)

##receptivity crispr rep 2
#obp56i
table1 = table(obp56i_r2$mated, obp56i_r2$male_geno)
table1
prop_table1 = prop.table(table(obp56i_r2$mated, obp56i_r2$male_geno), 2)
prop_table1

#transform to percent
prop1 = apply(prop_table1, 2, function(x){x*100})
prop1

fisher.test(table1)

#extract p val from fisher test and add it to vector of p vals
p_56i_remate_2=fisher.test(table1)$p.value
pvals_remating_2 = c(p_56i_remate_2)

#obp51a
table1 = table(obp51a_r2$mated, obp51a_r2$male_geno)
table1
prop_table1 = prop.table(table(obp51a_r2$mated, obp51a_r2$male_geno), 2)
prop_table1

#transform to percent
prop1 = apply(prop_table1, 2, function(x){x*100})
prop1

fisher.test(table1)

#extract p val from fisher test and add it to vector of p vals
p_51a_remate_2=fisher.test(table1)$p.value
pvals_remating_2 = append(pvals_remating_2, p_51a_remate_2)

#obp56e
table1 = table(obp56e_r2$mated, obp56e_r2$male_geno)
table1
prop_table1 = prop.table(table(obp56e_r2$mated, obp56e_r2$male_geno), 2)
prop_table1

#transform to percent
prop1 = apply(prop_table1, 2, function(x){x*100})
prop1

fisher.test(table1)

#extract p val from fisher test and add it to vector of p vals
p_56e_remate_2=fisher.test(table1)$p.value
pvals_remating_2 = append(pvals_remating_2, p_56e_remate_2)

##obp22a
table1 = table(obp22a_r2$mated, obp22a_r2$male_geno)
table1
prop_table1 = prop.table(table(obp22a_r2$mated, obp22a_r2$male_geno), 2)
prop_table1

#transform to percent
prop1 = apply(prop_table1, 2, function(x){x*100})
prop1

fisher.test(table1)

#extract p val from fisher test and add it to vector of p vals
p_22a_remate_2=fisher.test(table1)$p.value
pvals_remating_2 = append(pvals_remating_2, p_22a_remate_2)

#obp56f
table1 = table(obp56f_r2$mated, obp56f_r2$male_geno)
table1
prop_table1 = prop.table(table(obp56f_r2$mated, obp56f_r2$male_geno), 2)
prop_table1

#transform to percent
prop1 = apply(prop_table1, 2, function(x){x*100})
prop1

fisher.test(table1)

#extract p val from fisher test and add it to vector of p vals
p_56f_remate_2=fisher.test(table1)$p.value
pvals_remating_2 = append(pvals_remating_2, p_56f_remate_2)

#obp8a
table1 = table(obp8a_r2$mated, obp8a_r2$male_geno)
table1
prop_table1 = prop.table(table(obp8a_r2$mated, obp8a_r2$male_geno), 2)
prop_table1

#transform to percent
prop1 = apply(prop_table1, 2, function(x){x*100})
prop1

fisher.test(table1)

#extract p val from fisher test and add it to vector of p vals
p_8a_remate_2=fisher.test(table1)$p.value
pvals_remating_2 = append(pvals_remating_2, p_8a_remate_2)

#BH correction on vector of p vals
p.adjust(pvals_remating_1, "BH", 6)
p.adjust(pvals_remating_2, "BH", 6)

#make stacked bar charts
#load count data (this is the same data as above, just in different format)
recep_totals = read.csv("barchart_receptivity.csv")

#subset replicates
recep_1 = subset(recep_totals, recep_totals$rep=="1")
recep_2 = subset(recep_totals, recep_totals$rep=="2")

##stacked bar plots rep1
ggplot(recep_1, aes(y=number, x=male_geno, fill=recep)) + 
    geom_bar(position="fill", stat="identity") +
  facet_wrap(~gene, scales="free_x") +
    labs(x="Male Genotype", y="Proportion of females", fill="Remated?")+
  theme_classic()+
  theme(panel.spacing = unit(1, "lines")) + 
  theme(strip.text.x = element_text(colour = "black")) +
  theme(strip.background = element_blank())

##stacked bar plots rep2
ggplot(recep_2, aes(y=number, x=male_geno, fill=recep)) + 
    geom_bar(position="fill", stat="identity") +
  facet_wrap(~gene, scales="free_x") +
    labs(x="Male Genotype", y="Proportion of females", fill="Remated?")+
  theme_classic()+
  theme(panel.spacing = unit(1, "lines")) + 
  theme(strip.text.x = element_text(colour = "black")) +
  theme(strip.background = element_blank())

```

```{r}
##latency/duration rep1
#obp56i
latency2 = 60*24*(as.numeric(times(obp56i_r1$lat)))
obp56i_r1 = cbind(obp56i_r1, latency2)
duration2 = 60*24*(as.numeric(times(obp56i_r1$dur)))
obp56i_r1 = cbind(obp56i_r1, duration2)

t.test(obp56i_r1$duration2~obp56i_r1$male_geno)
#extract p value from t.test and append to list of p vals
obp56i_dur_p=t.test(obp56i_r1$duration2~obp56i_r1$male_geno)$p.value
p_val_list_dur1=c(obp56i_dur_p)

t.test(obp56i_r1$latency2~obp56i_r1$male_geno)
#extract p value from t.test and append to list of p vals
obp56i_lat_p=t.test(obp56i_r1$latency2~obp56i_r1$male_geno)$p.value
p_val_list_lat1=c(obp56i_lat_p)

#obp51a
latency2 = 60*24*(as.numeric(times(obp51a_r1$lat)))
obp51a_r1 = cbind(obp51a_r1, latency2)
duration2 = 60*24*(as.numeric(times(obp51a_r1$dur)))
obp51a_r1 = cbind(obp51a_r1, duration2)

t.test(obp51a_r1$duration2~obp51a_r1$male_geno)
#extract p value from t.test and append to list of p vals
obp51a_dur_p=t.test(obp51a_r1$duration2~obp51a_r1$male_geno)$p.value
p_val_list_dur1=append(p_val_list_dur1, obp51a_dur_p)

t.test(obp51a_r1$latency2~obp51a_r1$male_geno)
#extract p value from t.test and append to list of p vals
obp51a_lat_p=t.test(obp51a_r1$latency2~obp51a_r1$male_geno)$p.value
p_val_list_lat1=append(p_val_list_lat1, obp51a_lat_p)

#obp56e
latency2 = 60*24*(as.numeric(times(obp56e_r1$lat)))
obp56e_r1 = cbind(obp56e_r1, latency2)
duration2 = 60*24*(as.numeric(times(obp56e_r1$dur)))
obp56e_r1 = cbind(obp56e_r1, duration2)

t.test(obp56e_r1$duration2~obp56e_r1$male_geno)
#extract p value from t.test and append to list of p vals
obp56e_dur_p=t.test(obp56e_r1$duration2~obp56e_r1$male_geno)$p.value
p_val_list_dur1=append(p_val_list_dur1, obp56e_dur_p)

t.test(obp56e_r1$latency2~obp56e_r1$male_geno)
#extract p value from t.test and append to list of p vals
obp56e_lat_p=t.test(obp56e_r1$latency2~obp56e_r1$male_geno)$p.value
p_val_list_lat1=append(p_val_list_lat1, obp56e_lat_p)

#obp22a
latency2 = 60*24*(as.numeric(times(obp22a_r1$lat)))
obp22a_r1 = cbind(obp22a_r1, latency2)
duration2 = 60*24*(as.numeric(times(obp22a_r1$dur)))
obp22a_r1 = cbind(obp22a_r1, duration2)

t.test(obp22a_r1$duration2~obp22a_r1$male_geno)
#extract p value from t.test and append to list of p vals
obp22a_dur_p=t.test(obp22a_r1$duration2~obp22a_r1$male_geno)$p.value
p_val_list_dur1=append(p_val_list_dur1, obp22a_dur_p)

t.test(obp22a_r1$latency2~obp22a_r1$male_geno)
#extract p value from t.test and append to list of p vals
obp22a_lat_p=t.test(obp22a_r1$latency2~obp22a_r1$male_geno)$p.value
p_val_list_lat1=append(p_val_list_lat1, obp22a_lat_p)

#obp56f
latency2 = 60*24*(as.numeric(times(obp56f_r1$lat)))
obp56f_r1 = cbind(obp56f_r1, latency2)
duration2 = 60*24*(as.numeric(times(obp56f_r1$dur)))
obp56f_r1 = cbind(obp56f_r1, duration2)

t.test(obp56f_r1$duration2~obp56f_r1$male_geno)
#extract p value from t.test and append to list of p vals
obp56f_dur_p=t.test(obp56f_r1$duration2~obp56f_r1$male_geno)$p.value
p_val_list_dur1=append(p_val_list_dur1, obp56f_dur_p)

t.test(obp56f_r1$latency2~obp56f_r1$male_geno)
#extract p value from t.test and append to list of p vals
obp56f_lat_p=t.test(obp56f_r1$latency2~obp56f_r1$male_geno)$p.value
p_val_list_lat1=append(p_val_list_lat1, obp56f_lat_p)

#obp8a
latency2 = 60*24*(as.numeric(times(obp8a_r1$lat)))
obp8a_r1 = cbind(obp8a_r1, latency2)
duration2 = 60*24*(as.numeric(times(obp8a_r1$dur)))
obp8a_r1 = cbind(obp8a_r1, duration2)

t.test(obp8a_r1$duration2~obp8a_r1$male_geno)
#extract p value from t.test and append to list of p vals
obp8a_dur_p=t.test(obp8a_r1$duration2~obp8a_r1$male_geno)$p.value
p_val_list_dur1=append(p_val_list_dur1, obp8a_dur_p)

t.test(obp8a_r1$latency2~obp8a_r1$male_geno)
#extract p value from t.test and append to list of p vals
obp8a_lat_p=t.test(obp8a_r1$latency2~obp8a_r1$male_geno)$p.value
p_val_list_lat1=append(p_val_list_lat1, obp8a_lat_p)

##rep 2
#obp56i
latency2 = 60*24*(as.numeric(times(obp56i_r2$lat)))
obp56i_r2 = cbind(obp56i_r2, latency2)
duration2 = 60*24*(as.numeric(times(obp56i_r2$dur)))
obp56i_r2 = cbind(obp56i_r2, duration2)

t.test(obp56i_r2$duration2~obp56i_r2$male_geno)
#extract p value from t.test and append to list of p vals
obp56i_dur_p2=t.test(obp56i_r2$duration2~obp56i_r2$male_geno)$p.value
p_val_list_dur2=c(obp56i_dur_p2)

t.test(obp56i_r2$latency2~obp56i_r2$male_geno)
#extract p value from t.test and append to list of p vals
obp56i_lat_p2=t.test(obp56i_r2$latency2~obp56i_r2$male_geno)$p.value
p_val_list_lat2=c(obp56i_lat_p2)

#obp51a
latency2 = 60*24*(as.numeric(times(obp51a_r2$lat)))
obp51a_r2 = cbind(obp51a_r2, latency2)
duration2 = 60*24*(as.numeric(times(obp51a_r2$dur)))
obp51a_r2 = cbind(obp51a_r2, duration2)

t.test(obp51a_r2$duration2~obp51a_r2$male_geno)
#extract p value from t.test and append to list of p vals
obp1a_dur_p2=t.test(obp51a_r2$duration2~obp51a_r2$male_geno)$p.value
p_val_list_dur2=append(p_val_list_dur2, obp1a_dur_p2)

t.test(obp51a_r2$latency2~obp51a_r2$male_geno)
#extract p value from t.test and append to list of p vals
obp51a_lat_p2=t.test(obp51a_r2$latency2~obp51a_r2$male_geno)$p.value
p_val_list_lat2=append(p_val_list_lat2, obp51a_lat_p2)

#obp56e
latency2 = 60*24*(as.numeric(times(obp56e_r2$lat)))
obp56e_r2 = cbind(obp56e_r2, latency2)
duration2 = 60*24*(as.numeric(times(obp56e_r2$dur)))
obp56e_r2 = cbind(obp56e_r2, duration2)

t.test(obp56e_r2$duration2~obp56e_r2$male_geno)
#extract p value from t.test and append to list of p vals
obp56e_dur_p2=t.test(obp56e_r2$duration2~obp56e_r2$male_geno)$p.value
p_val_list_dur2=append(p_val_list_dur2, obp56e_dur_p2)

t.test(obp56e_r2$latency2~obp56e_r2$male_geno)
#extract p value from t.test and append to list of p vals
obp56e_lat_p2=t.test(obp56e_r2$latency2~obp56e_r2$male_geno)$p.value
p_val_list_lat2=append(p_val_list_lat2, obp56e_lat_p2)

#obp22a
latency2 = 60*24*(as.numeric(times(obp22a_r2$lat)))
obp22a_r2 = cbind(obp22a_r2, latency2)
duration2 = 60*24*(as.numeric(times(obp22a_r2$dur)))
obp22a_r2 = cbind(obp22a_r2, duration2)

t.test(obp22a_r2$duration2~obp22a_r2$male_geno)
#extract p value from t.test and append to list of p vals
obp22a_dur_p2=t.test(obp22a_r2$duration2~obp22a_r2$male_geno)$p.value
p_val_list_dur2=append(p_val_list_dur2, obp22a_dur_p2)

t.test(obp22a_r2$latency2~obp22a_r2$male_geno)
#extract p value from t.test and append to list of p vals
obp22a_lat_p2=t.test(obp22a_r2$latency2~obp22a_r2$male_geno)$p.value
p_val_list_lat2=append(p_val_list_lat2, obp22a_lat_p2)

#obp56f
latency2 = 60*24*(as.numeric(times(obp56f_r2$lat)))
obp56f_r2 = cbind(obp56f_r2, latency2)
duration2 = 60*24*(as.numeric(times(obp56f_r2$dur)))
obp56f_r2 = cbind(obp56f_r2, duration2)

t.test(obp56f_r2$duration2~obp56f_r2$male_geno)
#extract p value from t.test and append to list of p vals
obp56f_dur_p2=t.test(obp56f_r2$duration2~obp56f_r2$male_geno)$p.value
p_val_list_dur2=append(p_val_list_dur2, obp56f_dur_p2)

t.test(obp56f_r2$latency2~obp56f_r2$male_geno)
#extract p value from t.test and append to list of p vals
obp56f_lat_p2=t.test(obp56f_r2$latency2~obp56f_r2$male_geno)$p.value
p_val_list_lat2=append(p_val_list_lat2, obp56f_lat_p2)

#obp8a
latency2 = 60*24*(as.numeric(times(obp8a_r2$lat)))
obp8a_r2 = cbind(obp8a_r2, latency2)
duration2 = 60*24*(as.numeric(times(obp8a_r2$dur)))
obp8a_r2 = cbind(obp8a_r2, duration2)

t.test(obp8a_r2$duration2~obp8a_r2$male_geno)
#extract p value from t.test and append to list of p vals
obp8a_dur_p2=t.test(obp8a_r2$duration2~obp8a_r2$male_geno)$p.value
p_val_list_dur2=append(p_val_list_dur2, obp8a_dur_p2)

t.test(obp8a_r2$latency2~obp8a_r2$male_geno)
#extract p value from t.test and append to list of p vals
obp8a_lat_p2=t.test(obp8a_r2$latency2~obp8a_r2$male_geno)$p.value
p_val_list_lat2=append(p_val_list_lat2, obp8a_lat_p2)

##perform BH correction on vector of p values from t tests 
p_val_list_dur1
p_val_list_lat1
p_val_list_dur2
p_val_list_lat2
p.adjust(p_val_list_dur1, "BH", 6)
p.adjust(p_val_list_lat1, "BH", 6)
p.adjust(p_val_list_dur2, "BH", 6)
p.adjust(p_val_list_lat2, "BH", 6)

##make plots latency/duration
#calculate latency and duration combined datasets
#rep1
latency2 = 60*24*(as.numeric(times(crispr_r1$lat)))
crispr_r1 = cbind(crispr_r1, latency2)
duration2 = 60*24*(as.numeric(times(crispr_r1$dur)))
crispr_r1 = cbind(crispr_r1, duration2)

#rep2
latency2 = 60*24*(as.numeric(times(crispr_r2$lat)))
crispr_r2 = cbind(crispr_r2, latency2)
duration2 = 60*24*(as.numeric(times(crispr_r2$dur)))
crispr_r2 = cbind(crispr_r2, duration2)

#latency rep1
plot = ggplot(data=crispr_r1, 
       aes(x=male_geno, 
           y=latency2), 
           fill=male_geno) +
  geom_dotplot(binaxis='y', stackdir = 'center', dotsize=0.45, alpha = 0.9) + 
  facet_grid(. ~ gene) +
  labs(x="Male Genotype", y="Mating latency (min)")+
  theme_classic()+
  theme(panel.spacing = unit(1, "lines")) + 
  theme(strip.text.x = element_text(colour = "black")) +
  theme(strip.background = element_blank())
plot

p = plot + stat_summary(fun.data=mean_se, fun.args = list(mult=1), 
                 geom="errorbar", position=position_dodge(1), color="gray48", width=0.2, size=0.4) +      stat_summary(fun.y=mean, geom="point", color="gray48", position=position_dodge(1)) 

#duration rep1
plot = ggplot(data=crispr_r2, 
       aes(x=male_geno, 
           y=duration2), 
           fill=male_geno) +
  geom_dotplot(binaxis='y', stackdir = 'center', dotsize=0.45, alpha = 0.9) + 
  facet_grid(. ~ gene) +
  labs(x="Male Genotype", y="Mating duration (min)")+
  theme_classic()+
  theme(panel.spacing = unit(1, "lines")) + 
  theme(strip.text.x = element_text(colour = "black")) +
  theme(strip.background = element_blank())
plot

p = plot + stat_summary(fun.data=mean_se, fun.args = list(mult=1), 
                 geom="errorbar", position=position_dodge(1), color="gray48", width=0.2, size=0.4) +      stat_summary(fun.y=mean, geom="point", color="gray48", position=position_dodge(1)) 

#latency rep2
plot = ggplot(data=crispr_r2, 
       aes(x=male_geno, 
           y=latency2), 
           fill=male_geno) +
  geom_dotplot(binaxis='y', stackdir = 'center', dotsize=0.45, alpha = 0.9) + 
  facet_grid(. ~ gene) +
  labs(x="Male Genotype", y="Mating latency (min)")+
  theme_classic()+
  theme(panel.spacing = unit(1, "lines")) + 
  theme(strip.text.x = element_text(colour = "black")) +
  theme(strip.background = element_blank())
plot

p = plot + stat_summary(fun.data=mean_se, fun.args = list(mult=1), 
                 geom="errorbar", position=position_dodge(1), color="gray48", width=0.2, size=0.4) +      stat_summary(fun.y=mean, geom="point", color="gray48", position=position_dodge(1)) 

#duration rep2
plot = ggplot(data=crispr_r2, 
       aes(x=male_geno, 
           y=duration2), 
           fill=male_geno) +
  geom_dotplot(binaxis='y', stackdir = 'center', dotsize=0.45, alpha = 0.9) + 
  facet_grid(. ~ gene) +
  labs(x="Male Genotype", y="Mating duration (min)")+
  theme_classic()+
  theme(panel.spacing = unit(1, "lines")) + 
  theme(strip.text.x = element_text(colour = "black")) +
  theme(strip.background = element_blank())
plot

p = plot + stat_summary(fun.data=mean_se, fun.args = list(mult=1), 
                 geom="errorbar", position=position_dodge(1), color="gray48", width=0.2, size=0.4) +      stat_summary(fun.y=mean, geom="point", color="gray48", position=position_dodge(1)) 

```

##Obp56g sperm count and mating plug proportion data (2 reps combined)
Definition of variables (counts):
vial: number of vial female placed in
male_geno: genotype of male CS female mated to. 56g=homozygous obp56g1;protBeGFP; CyO=heterozygous obp56g1/CyO;protBeGFP
freeze_time: time CS female assigned to be frozen post-mating. 3=3 hours, 4=4 days
mated: Y if this pair successfully copulated (Y for all)
frozen: Y if female was successfully frozen in liquid nitrogen (Y for all)
start: time at which flies began copulation
end: time at which flies ended copulation
count: number of GFP sperm in SR and ST (total combined across both types of storage organs)
notes: anything interesting observed during course of experiments

Definition of variables (mp proportions):
vial: number of vial female placed in
male_geno: genotype of male CS female mated to. 56g=homozygous obp56g1;protBeGFP; CyO=heterozygous obp56g1/CyO;protBeGFP
mp: Y/N if a mating plug was observed in the female bursa
sperm: Y/N if a sperm mass was observed in the female bursa
class: factor with 3 levels (A, B, or C). A=Y for mp, Y for sperm; B=N for mp, Y for sperm; C=N no for MP, no for sperm
notes: interesting observations made during the course of the experiments

```{r}
###sperm counts and mp proportion data
#import count data
counts = read.csv("56g_spermcounts.csv")

#explicitly order the levels within genotype so the control is first in the graph
counts$male_geno <- factor(counts$male_geno, levels = c("CyO", "56g"))

#make graphs
pal3 <- park_palette("ArcticGates", 2)
plot = ggplot(data=counts, 
       aes(x=male_geno, 
           y=count, 
           fill=male_geno)) + 
  geom_boxplot() +
  geom_dotplot(binaxis='y', stackdir = 'center', dotsize=0.45, fill="black") + 
  scale_fill_manual(values=pal3)+
  facet_grid(. ~ freeze_time, labeller=label_both) +
  labs(x="Male Genotype", y="Sperm in storage organs")+
  theme_bw()+
  theme(axis.title.y = element_text(size=18), axis.title.x = element_text(size=18), axis.text.y  = element_text(size=18),
           axis.text.x  = element_text(size=18), strip.text.x = element_text(size = 20))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  guides(fill=F)
plot

#subset the data to separate the freeze times to do the t-tests with
threehour = subset(counts, counts$freeze_time == 3)
fourday = subset(counts, counts$freeze_time == 4)

#do t-test
t.test(threehour$count~threehour$male_geno)
t.test(fourday$count~fourday$male_geno)

#do wilcoxon test as well 
wilcox.test(count ~ male_geno, data = threehour)
wilcox.test(count ~ male_geno, data = fourday)

#import mp proportion data
mp = read.csv("56g_mp_proportions.csv")

#explicitly order the levels within genotype so the control is first in the prop.table and the graph
mp$male_geno <- factor(mp$male_geno, levels = c("CyO", "56g"))

#get counts and percentges of class A-C
table1 = table(mp$class, mp$male_geno)
table1
prop_table1 = prop.table(table(mp$class, mp$male_geno), 2)
prop_table1

#transform to percent
prop1 = apply(prop_table1, 2, function(x){x*100})
prop1

#make plot
plot = barplot(prop1, col=c("#537D7F", "#99B7B8", "#F7F6F3"), xlab="Male Genotype", ylim=c(0,100), ylab="Percentage of females") 
plot
```

##obp56g RNAi KD experiments (tub-GAL4)
definition of variables (tubGAL4 counts):
Vial: vial CS female was placed into
Genotype: genotype of male CS female mated to. KD=tubGAL4>obp56gRNAi; WT=w1118>obp56gRNAi
d_1 through d_4: number of eggs each CS female laid on days 1-4
Total: sum of egg laids in d_1 through d_4

definition of variables (tubGAL4 remating):
male_geno: genotype of male CS female mated to. KD=tubGAL4>obp56gRNAi; Control=w1118>obp56gRNAi
recep: y/n if a given female remated with a CS male on the fourth day post-mating within a one hour time frame
number: number of females that fall into each class in recep category

```{r}
#import data
tubkd = read.csv("tubgal4_counts.csv")

#get data into "long form" for linear models egg lay
tubkd_long = tubkd %>%
  pivot_longer(cols = starts_with("d_"),
   names_to = "day",
   names_prefix = "d_",
   values_to = "eggs",
   values_drop_na = TRUE)
tubkd_long$day = as.factor(tubkd_long$day)

#make plot
plot = ggplot(data=tubkd_long, 
       aes(x=day, 
           y=eggs, color=Genotype, fill=Genotype)) + 
  geom_dotplot(binaxis='y', stackdir = 'center', dotsize=0.6, position=position_dodge(1), alpha = 0.75) + 
  facet_grid(. ~ Day, scales="free_x", space='free_x', labeller=label_both) +
  labs(x="Day", y="Eggs Laid")+
  theme_classic()+
  expand_limits(x = 1) +
  theme(panel.spacing = unit(1, "lines")) + 
  theme(strip.text.x = element_text(colour = "black")) +
  theme(strip.background = element_blank()) 

p = plot + stat_summary(fun.data=mean_se, fun.args = list(mult=1), 
                 geom="errorbar", position=position_dodge(1), color="gray48", width=0.05, size=0.4) +      stat_summary(fun.y=mean, geom="point", color="gray48", position=position_dodge(1)) + theme(panel.spacing = unit(2, "lines"))

#run linear model 
model1 = glmer(eggs ~ Genotype + day + (1|Vial), family=poisson, data=tubkd_long)
summary(model1)
model2 = glmer(eggs ~ day + (1|Vial), family=poisson, data=tubkd_long)
summary(model2)
anova(model2, model1)

#marginal mean comparison with emmeans
model1=glmer(eggs ~ Genotype*day + (1|Vial), family=poisson, data=tubkd_long)
emmeans(model1, pairwise ~ Genotype | day)

#tubgal4 remating data
tub_remating = read.csv("tubgal4_remating.csv")

#make prop.table
table1 = table(tub_remating$mated, tub_remating$male_geno)
table1
prop_table1 = prop.table(table(tub_remating$mated, tub_remating$male_geno), 2)
prop_table1

#transform to percent
prop1 = apply(prop_table1, 2, function(x){x*100})
prop1

fisher.test(table1)

#make plot
plot2 = barplot(prop1, col=c("indianred2", "lightblue"), xlab="Male Genotype", ylim=c(0,100), ylab="Female Remating Rate (%)", legend=rownames(prop1))
plot2
```

##obp56g RNAi experiments (crebA-GAL4)
definition of variables (counts):
male_geno: genotype of male CS female mated to. wt=CrebA-GAL4>w1118; kd=CrebA-GAL4>obp56gRNAi
vial: vial CS female placed into
intro: time at which male was added to the vial
start: time at which flies began copulation
done: time at which flies finished copulation
d_1 through d_4: number of eggs each female laid from days 1-4 post-mating
egg_tot: sum of eggs from d_1 through d_4
recep: Y/N if that female remated with a CS male 4 days post-mating

definition of variables (mp proportions):
vial: vial: vial CS female placed into
male_geno: genotype of male CS female mated to. wt=CrebA-GAL4>w1118; kd=CrebA-GAL4>obp56gRNAi
mated: Y/N if that particular female mated (Y for all)
start: time at which flies began copulation
end: time at which flies finished copulation
notes: anything interesting observed during course of experiments
plug: Y/N if a mating plug was observed in the female bursa immediately after the end of mating

```{r}
#import the data
creb_counts = read.csv("crebgal4_counts.csv")

#reorder male_geno so control appears first in the graph
creb_counts$male_geno <- factor(creb_counts$male_geno, levels = c("wt", "kd"))

#get data into "long form" for linear models egg lay
creb_counts_long = creb_counts %>%
  pivot_longer(cols = starts_with("d_"),
   names_to = "day",
   names_prefix = "d_",
   values_to = "eggs",
   values_drop_na = TRUE)
creb_counts_long$day = as.factor(creb_counts_long$day)

#make plot
plot = ggplot(data=creb_counts_long, 
       aes(x=day, 
           y=eggs, color=male_geno, fill=male_geno)) + 
  geom_dotplot(binaxis='y', stackdir = 'center', dotsize=0.6, position=position_dodge(1), alpha = 0.75) + 
  #scale_fill_manual(values=pal)+
  facet_grid(. ~ day, scales="free_x", space='free_x', labeller=label_both) +
  #facet_grid(gene ~ day) +
  labs(x="Day", y="Eggs Laid")+
  theme_classic()+
  expand_limits(x = 1) +
  theme(panel.spacing = unit(1, "lines")) + 
  theme(strip.text.x = element_text(colour = "black")) +
  theme(strip.background = element_blank()) 
plot


p = plot + stat_summary(fun.data=mean_se, fun.args = list(mult=1), 
                 geom="errorbar", position=position_dodge(1), color="gray48", width=0.05, size=0.4) +      stat_summary(fun.y=mean, geom="point", color="gray48", position=position_dodge(1)) + theme(panel.spacing = unit(2, "lines"))

#linear model
model1 = glmer(eggs ~ male_geno + day + (1|vial), family=poisson, data=creb_counts_long)
summary(model1)
model2 = glmer(eggs ~ day + (1|vial), family=poisson, data=creb_counts_long)
summary(model2)
anova(model2, model1)

#marginal mean comparison
model1=glmer(eggs~male_geno*day + (1|vial), family=poisson, data=creb_counts_long)
emmeans(model1, pairwise ~ male_geno | day)

#make proportion table to see proportion of females that remated @ 4 days. 
table1 = table(creb_counts$recep, creb_counts$male_geno)
table1
prop_table1 = prop.table(table(creb_counts$recep, creb_counts$male_geno), 2)
prop_table1

#transform to percent
prop1 = apply(prop_table1, 2, function(x){x*100})
prop1

fisher.test(table1)

plot = barplot(prop1, col=c("indianred2", "lightblue"), xlab="Male Genotype", ylim=c(0,100), ylab="Female Remating Rate (%)", legend=rownames(prop1))

#mp proportions
#import data
crebgal4_mp_prop=read.csv("crebgal4_mp_proportions.csv")
#reorder male_geno so control appears first in the graph
crebgal4_mp_prop$male_geno <- factor(crebgal4_mp_prop$male_geno, levels = c("wt", "kd"))

#make proportion table to see proportion of females with mating plugs in bursa
table1 = table(crebgal4_mp_prop$plug, crebgal4_mp_prop$male_geno)
table1
prop_table1 = prop.table(table(crebgal4_mp_prop$plug, crebgal4_mp_prop$male_geno), 2)
prop_table1

#transform to percent
prop1 = apply(prop_table1, 2, function(x){x*100})
prop1

fisher.test(table1)

plot = barplot(prop1, col=c("indianred2", "lightblue"), xlab="Male Genotype", ylim=c(0,100), ylab="Females with mating plugs in bursa (%)", legend=rownames(prop1))


```

