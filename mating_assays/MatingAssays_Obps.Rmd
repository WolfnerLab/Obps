---
title: "Obp R analyses"
author: "Nora C Brown, Benjamin Gordon, Caitlin E. McDonough-Goldstein, Snigdha Misra, Geoffrey D. Findlay, Andrew G. Clark, Mariana F. Wolfner"
output: html_document
---

This is an R markdown document that contains all code to analyze the data published in "The seminal odorant binding protein Obp56g is required in mating plug formation and male fertility in Drosophila melanogaster" 

##Obp56g deficiency assays
Definition of variables:
rep: replicate of experiment
vial: number of vial female placed in
male_geno: genotype of male CS female mated to
intro: time male introduced to vial
time_start: time flies began copulating
time_stop: time flies finished copulating
d_1 through d_4: number of eggs female laid on days 1-4
e_tot: sum of eggs in d_1 through d_4
mated: Y/N if that female mated with a CS male on the fourth day after mating within a one hour time frame
p_1 through p_4: number of pupae in vials days 1-4
p_tot: sum of pupae in p_1 through p_4
hatch_t: total hatchability, p_t/d_t (only measured for reps 1 & 2)
h_1 through h_4: hatchabillity of eggs on days 1-4, calculated as ex: p_1/d_1
lat: latency to mate, calculated as time_start-intro (note: not measured for replicate 1)
dur: duration of mating, calculated as time_stop-time_start

```{r}
#load packages needed from library
library(ggplot2)
library(dplyr)
library(tidyverse)
library(lme4)
library(rstatix)
library(chron)
library(emmeans)
library(nationalparkcolors)
library(tidyr)
library(ggbeeswarm)
library(forcats)
```


```{r}
#import data
df2r_data = read.csv("~/Df2R_data.csv")

#reorder levels within male genotype 
df2r_data$male_geno <- factor(df2r_data$male_geno, levels = c("Df/WT", "WT/CyO", "Obp56g/CyO", "Obp56g/Df"))

#set replicate as a factor
df_all$rep=as.factor(df_all$rep)

```

```{r}
#get data in "long form" for graphing egg by day & for linear model
df_all_long = df2r_data %>%
  pivot_longer(cols = starts_with("d_"),
               names_to = "day", 
               values_to = "eggs", 
               values_drop_na = TRUE)

#plot egg lay
p1 = ggplot(data = df_all_long,
            aes(x=factor(male_geno, levels=c("Df/WT", "WT/CyO", "Obp56g/CyO", "Obp56g/Df")), y=eggs, color=male_geno)) + 
  labs(x="Day", y="Eggs Laid") + 
  facet_grid(~day) + 
  theme(axis.text.x = element_text(angle=45, hjust=1)) + 
  theme(legend.position = "none") + 
  theme(panel.background = element_rect(fill="white", colour="grey")) +
  geom_quasirandom(dodge.width=.9,alpha=.4) + 
  expand_limits(x = 1, y=80) + 
  theme_classic()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  theme(panel.spacing = unit(0.01, "cm")) + 
  theme(strip.text.x = element_text(colour = "black")) +
  theme(strip.background = element_blank()) 
  
p1 + stat_summary(fun.data=mean_se, fun.args=list(mult=1), geom="errorbar", position=position_dodge(1), color="gray48", width=0.3, size=0.6) + stat_summary(fun.y=mean, geom="point", color="gray48", position=position_dodge(1)) + theme(panel.spacing=unit(2, "lines"))

#linear model egg lay
df_all_long$day = as.factor(df_all_long$day)
model1 = glmer(eggs ~ male_geno + day  + (1|rep) + (1|vial), family=poisson, data=df_all_long, glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000)))
summary(model1)
model2 = glmer(eggs ~ day  + (1|rep) + (1|vial), family = poisson, data=df_all_long, glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000)))
summary(model2)
anova(model2, model1)

#emmeans to compare marginal means, add male_geno*day interaction term
model3 = glmer(eggs ~ male_geno + day  + male_geno*day + (1|rep) + (1|vial), family=poisson, data=df_all_long, glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 100000)))
emmeans(model3, pairwise ~ male_geno | day)
```


```{r}
#remating rates
#make proportion table to see proportion of females that remated @ 4 days. 
tab1 = table(df_all$male_geno, df_all$mated)
tab1
ptab1 = prop.table(tab1, 2)
ptab1
pairwise_prop_test(tab1)
pairwise_fisher_test(tab1)

#make plot
df_recep=read.csv("~/df_recep.csv")
ggplot(df_recep, aes(y=number, x=factor(male_geno, levels=c("Df/WT", "CyO/WT", "Obp56g/CyO", "Obp56g/Df")), fill=recep)) + 
    geom_bar(position="fill", stat="identity") +
    labs(x="Male Genotype", y="Proportion of females", fill="Remated?")+
  theme_classic()+
  theme(panel.spacing = unit(1, "lines")) + 
  theme(strip.text.x = element_text(colour = "black")) +
  theme(strip.background = element_blank())
```

```{r}
#mating duration
dur2 = 60*24*(as.numeric(times(df_all$dur)))
df_all = cbind(df_all, dur2)

#mating latency
lat2 = 60*24*(as.numeric(times(df_all$lat)))
df_all = cbind(df_all, lat2)

#linear model to test duration & latency differences
model1 = lmer(dur2 ~ male_geno + (1|rep), data=df_all)
summary(model1)
model2 = lmer(dur2 ~ (1|rep), data=df_all)
anova(model1, model2)

model1 = lmer(lat2 ~ male_geno + (1|rep), data=df_all)
summary(model1)
model2 = lmer(lat2 ~ (1|rep), data=df_all)
anova(model1, model2)

#emmeans
model1 = lmer(dur2 ~ male_geno + (1|rep), data=df_all)
emmeans(model1, pairwise ~ male_geno)

model1 = lmer(lat2 ~ male_geno + (1|rep), data=df_all)
emmeans(model1, pairwise ~ male_geno)

#duration plot
p1 = ggplot(data = df_all,
            aes(x=factor(male_geno, levels=c("Df/WT", "WT/CyO", "Obp56g/CyO", "Obp56g/Df")), y=dur2, color=male_geno)) + 
  labs(x="Male Genotype", y="Mating Duration") + 
  theme(axis.text.x = element_text(angle=45, hjust=1)) + 
  theme(legend.position = "none") + 
  theme(panel.background = element_rect(fill="white", colour="grey")) + 
  geom_quasirandom(dodge.width=.9,alpha=.4, size=1.7) 
  
p1 + stat_summary(fun.data=mean_se, fun.args=list(mult=1), geom="errorbar", position=position_dodge(1), color="gray48", width=0.05, size=0.4) + stat_summary(fun.y=mean, geom="point", color="gray48", position=position_dodge(1)) + theme(panel.spacing=unit(2, "lines"))

#latency plot
p1 = ggplot(data = df_all,
            aes(x=factor(male_geno, levels=c("Df/WT", "WT/CyO", "Obp56g/CyO", "Obp56g/Df")), y=lat2, color=male_geno)) + 
  labs(x="Male Genotype", y="Mating Latency") + 
  theme(axis.text.x = element_text(angle=45, hjust=1)) + 
  theme(legend.position = "none") + 
  theme(panel.background = element_rect(fill="white", colour="grey")) + 
  geom_quasirandom(alpha=.4, size=1.7)
  
p1 + stat_summary(fun.data=mean_se, fun.args=list(mult=1), geom="errorbar", position=position_dodge(1), color="gray48", width=0.05, size=0.4) + stat_summary(fun.y=mean, geom="point", color="gray48", position=position_dodge(1)) + theme(panel.spacing=unit(2, "lines"))

```

##CRISPR mating assays (CyO/KO comparison)
Definition of variables:
vial: vial CS female is put into
replicate: replicate of experiment
gene: obp gene that is mutated
male_geno: genotype of male CS female is mated to, either CyO (control) or KO (experimental)--note this same notation is used for obp8a 
intro: time male introduced to vial
start: time flies began copulating
done: time flies finished copulating
lat: latency to mate, calculated as start-intro 
dur: duration of mating, calculated as done-start
d_1 through d_4: number of eggs female laid on days 1-4
e_tot: sum of eggs in d_1 through d_4
mated: Y/N if that female mated with a CS male on the fourth day after mating within a one hour time frame
p_1 through p_4: number of pupae in vials days 1-4
pup_t: sum of pupae in p_1 through p_4
h_1 through h_4: hatchabillity of eggs on days 1-4, calculated as ex: p_1/d_1
hatch_tot: total hatchability, pup_t/e_tot

```{r}
#read in data
data_comb = read.csv("~/crispr_combined.csv")

#convert latency and duration measurements into minutes 
dur2 = 60*24*(as.numeric(times(data_comb$dur)))
data_comb = cbind(data_comb, dur2)

lat2 = 60*24*(as.numeric(times(data_comb$lat)))
data_comb = cbind(data_comb, lat2)

#subset genes for later steps (nc# refers to fly line number, it is not meaningful experimentally)
nc110_2 = subset(data_comb, data_comb$gene == "56i")
nc182_2 = subset(data_comb, data_comb$gene == "51a")
nc126_2 = subset(data_comb, data_comb$gene == "56e")
nc141_2 = subset(data_comb, data_comb$gene == "22a")
nc123_2 = subset(data_comb, data_comb$gene == "56f")
nc8a_2 = subset(data_comb, data_comb$gene == "8a")
```

```{r}
###plot CRISPR egg lay (CyO/KO comparison)###
plot = ggplot(data=data_comb, 
       aes(x=male_geno, 
           y=e_tot, color=male_geno)) +
  facet_grid(. ~ gene) +
  labs(x="Male Genotype", y="Eggs laid (total)")+
  theme_classic()+
  theme(panel.spacing = unit(1, "lines")) + 
  theme(strip.text.x = element_text(colour = "black")) +
  theme(strip.background = element_blank())+
  geom_quasirandom(dodge.width=.9,alpha=.4) 

p = plot + stat_summary(fun.data=mean_se, fun.args=list(mult=1), geom="errorbar", position=position_dodge(1), color="gray48", width=0.3, size=0.6) + stat_summary(fun.y=mean, geom="point", color="gray48", position=position_dodge(1)) 
```

```{r}
###latency/duration plots (CyO/KO comparison)###
#plot CRISPR latency (CyO/KO comparison)
plot = ggplot(data=data_comb, 
       aes(x=male_geno, 
           y=lat2, color=male_geno)) +
  facet_grid(. ~ gene) +
  labs(x="Male Genotype", y="Mating latency (min)")+
  theme_classic()+
  theme(panel.spacing = unit(1, "lines")) + 
  theme(strip.text.x = element_text(colour = "black")) +
  theme(strip.background = element_blank())+
  geom_quasirandom(dodge.width=.9,alpha=.4) 

p = plot + stat_summary(fun.data=mean_se, fun.args=list(mult=1), geom="errorbar", position=position_dodge(1), color="gray48", width=0.3, size=0.6) + stat_summary(fun.y=mean, geom="point", color="gray48", position=position_dodge(1)) 

#plot CRISPR duration (CyO/KO comparison)
plot = ggplot(data=data_comb, 
       aes(x=male_geno, 
           y=dur2, color=male_geno)) +
  facet_grid(. ~ gene) +
  labs(x="Male Genotype", y="Mating latency (min)")+
  theme_classic()+
  theme(panel.spacing = unit(1, "lines")) + 
  theme(strip.text.x = element_text(colour = "black")) +
  theme(strip.background = element_blank())+
  geom_quasirandom(dodge.width=.9,alpha=.4) 

p = plot + stat_summary(fun.data=mean_se, fun.args=list(mult=1), geom="errorbar", position=position_dodge(1), color="gray48", width=0.3, size=0.6) + stat_summary(fun.y=mean, geom="point", color="gray48", position=position_dodge(1)) 

```

```{r}
###plot CRISPR remating rates (CyO/KO comparison) ###
#the data in the following spreadsheet is the same as that in data_comb, just in a different format (total counts)
recep_comb = read.csv("~/crispr_combined_recep_numbers.csv")
p = ggplot(recep_comb, aes(y=number, x=male_geno, fill=recep)) + 
  geom_bar(position="fill", stat="identity") + 
  facet_wrap(~gene, scales="free_x") + 
  labs(x="Male Genotype", y="Proportion of Females", fill="Remated?") + 
  theme_classic() + 
  theme(panel.spacing = unit(1, "lines")) + 
  theme(strip.text.x = element_text(colour="black")) + 
  theme(strip.background = element_blank()) 

```

```{r}
###duration/latency tests CRISPR mutants (CyO/KO comparison)###
##56i
model1 = lmer(dur2 ~ male_geno + (1|replicate), data=nc110_2)
summary(model1)
model2 = lmer(dur2 ~ (1|replicate), data=nc110_2)
summary(model2)
anova(model1, model2)

emmeans(model1, list(pairwise~male_geno))

model3 = lmer(lat2 ~ male_geno + (1|replicate), data=nc110_2)
summary(model1)
model4 = lmer(lat2 ~ (1|replicate), data=nc110_2)
summary(model2)
anova(model3, model4)

emmeans(model3, list(pairwise~male_geno))

##51a
model1 = lmer(dur2 ~ male_geno + (1|replicate), data=nc182_2)
summary(model1)
model2 = lmer(dur2 ~ (1|replicate), data=nc110_2)
summary(model2)
anova(model1, model2)

emmeans(model1, list(pairwise~male_geno))

model3 = lmer(lat2 ~ male_geno + (1|replicate), data=nc182_2)
summary(model1)
model4 = lmer(lat2 ~ (1|replicate), data=nc110_2)
summary(model2)
anova(model3, model4)

emmeans(model3, list(pairwise~male_geno))

##56e
model1 = lmer(dur2 ~ male_geno + (1|replicate), data=nc126_2)
summary(model1)
model2 = lmer(dur2 ~ (1|replicate), data=nc126_2)
summary(model2)
anova(model1, model2)

emmeans(model1, list(pairwise~male_geno))

model3 = lmer(lat2 ~ male_geno + (1|replicate), data=nc126_2)
summary(model1)
model4 = lmer(lat2 ~ (1|replicate), data=nc126_2)
summary(model2)
anova(model3, model4)

emmeans(model3, list(pairwise~male_geno))

##22a
model1 = lmer(dur2 ~ male_geno + (1|replicate), data=nc141_2)
summary(model1)
model2 = lmer(dur2 ~ (1|replicate), data=nc141_2)
summary(model2)
anova(model1, model2)

emmeans(model1, list(pairwise~male_geno))

model3 = lmer(lat2 ~ male_geno + (1|replicate), data=nc141_2)
summary(model1)
model4 = lmer(lat2 ~ (1|replicate), data=nc141_2)
summary(model2)
anova(model3, model4)

emmeans(model3, list(pairwise~male_geno))

##56f
model1 = lmer(dur2 ~ male_geno + (1|replicate), data=nc123_2)
summary(model1)
model2 = lmer(dur2 ~ (1|replicate), data=nc123_2)
summary(model2)
anova(model1, model2)

emmeans(model1, list(pairwise~male_geno))

model3 = lmer(lat2 ~ male_geno + (1|replicate), data=nc123_2)
summary(model1)
model4 = lmer(lat2 ~ (1|replicate), data=nc123_2)
summary(model2)
anova(model3, model4)

emmeans(model3, list(pairwise~male_geno))

##8a
model1 = lmer(dur2 ~ male_geno + (1|replicate), data=nc8a_2)
summary(model1)
model2 = lmer(dur2 ~ (1|replicate), data=nc8a_2)
summary(model2)
anova(model1, model2)

emmeans(model1, list(pairwise~male_geno))

model3 = lmer(lat2 ~ male_geno + (1|replicate), data=nc8a_2)
anova(model1)
model4 = lmer(lat2 ~ (1|replicate), data=nc8a_2)
summary(model2)
anova(model3, model4)

emmeans(model3, list(pairwise~male_geno))

#dur p val correction (p vals come from emmeans comparisons in the linear models above)
p=c(0.5763, 0.6059, 0.0488, 0.5508, 0.9359, 0.0001)
p.adjust(p, "BH", 6)

#lat p val correction (p vals come from emmeans comparisons in the linear models above)
p=c(0.0296, 0.6926, 0.8170, 0.1452, 0.7444, 0.1673)
p.adjust(p, "BH", 6)
```

```{r}
###remating rates test CRISPR mutants (CyO/KO comparison)###
table1 = table(nc110_2$mated, nc110_2$male_geno)
fisher.test(table1)

table1 = table(nc182_2$mated, nc182_2$male_geno)
fisher.test(table1)

table1 = table(nc126_2$mated, nc126_2$male_geno)
fisher.test(table1)

table1 = table(nc141_2$mated, nc141_2$male_geno)
fisher.test(table1)

table1 = table(nc123_2$mated, nc123_2$male_geno)
fisher.test(table1)

table1 = table(nc8a_2$mated, nc8a_2$male_geno)
fisher.test(table1)

#remating p val correction
p=c(0.4553, 0.7936, 0.7115, 0.6346, 0.4245, 0.00008906)
p.adjust(p, "BH", 6)
```

```{r}
###transform into long form for linear model (CyO/KO comparison)###
##nc110
nc110_long = nc110_2 %>%
  pivot_longer(cols = starts_with("d_"),
   names_to = "day",
   names_prefix = "d_",
   values_to = "eggs",
   values_drop_na = TRUE)
nc110_long$day = as.factor(nc110_long$day)

##nc182
nc182_long = nc182_2 %>%
  pivot_longer(cols = starts_with("d_"),
   names_to = "day",
   names_prefix = "d_",
   values_to = "eggs",
   values_drop_na = TRUE)
nc182_long$day = as.factor(nc182_long$day)

##nc126
nc126_long = nc126_2 %>%
  pivot_longer(cols = starts_with("d_"),
   names_to = "day",
   names_prefix = "d_",
   values_to = "eggs",
   values_drop_na = TRUE)
nc126_long$day = as.factor(nc126_long$day)

##nc141
nc141_long = nc141_2 %>%
  pivot_longer(cols = starts_with("d_"),
   names_to = "day",
   names_prefix = "d_",
   values_to = "eggs",
   values_drop_na = TRUE)
nc141_long$day = as.factor(nc141_long$day)

##nc123
nc123_long = nc123_2 %>%
  pivot_longer(cols = starts_with("d_"),
   names_to = "day",
   names_prefix = "d_",
   values_to = "eggs",
   values_drop_na = TRUE)
nc123_long$day = as.factor(nc123_long$day)

##8a
nc8a_long = nc8a_2 %>%
  pivot_longer(cols = starts_with("d_"),
   names_to = "day",
   names_prefix = "d_",
   values_to = "eggs",
   values_drop_na = TRUE)
#nc8a_long$day = as.factor(nc8a_long$day)
```

```{r}
###linear models egg lay###
##56i
model1 = glmer(eggs ~ male_geno + day + (1|replicate) +  (1|vial), family=poisson, data=nc110_long)
summary(model1)
model2 = glmer(eggs ~ day + (1|replicate) + (1|vial), family=poisson, data=nc110_long)
summary(model2)
anova(model2, model1)

##51a
model1 = glmer(eggs ~ male_geno + day + (1|replicate) + (1|vial), family=poisson, data=nc182_long)
summary(model1)
model2 = glmer(eggs ~ day + (1|replicate) + (1|vial), family=poisson, data=nc182_long)
summary(model2)
anova(model2, model1)

##56e
model1 = glmer(eggs ~ male_geno + day + (1|replicate) + (1|vial), family=poisson, data=nc126_long)
summary(model1)
model2 = glmer(eggs ~ day + (1|replicate) + (1|vial), family=poisson, data=nc126_long)
summary(model2)
anova(model2, model1)

##22a
model1 = glmer(eggs ~ male_geno + day + (1|replicate) + (1|vial), family=poisson, data=nc141_long)
summary(model1)
model2 = glmer(eggs ~ day + (1|replicate) + (1|vial), family=poisson, data=nc141_long)
summary(model2)
anova(model2, model1)

##56f
model1 = glmer(eggs ~ male_geno + day + (1|replicate) + (1|vial), family=poisson, data=nc123_long)
summary(model1)
model2 = glmer(eggs ~ day + (1|replicate) + (1|vial), family=poisson, data=nc123_long)
summary(model2)
anova(model2, model1)

##8a
model1 = glmer(eggs ~ male_geno + day + (1|replicate) + (1|vial), family=poisson, data=nc8a_long)
summary(model1)
model2 = glmer(eggs ~ day + (1|replicate)  + (1|vial), family=poisson, data=nc8a_long)
summary(model2)
anova(model1, model2)

##egg lay pval correction 
p = c(0.728, 0.645, 0.0986, 0.44255, 0.905, 0.0159)
p.adjust(p, method="BH", 6)
```

```{r}
###hatch###
##nc110
nc110_long = nc110_2 %>%
  pivot_longer(cols = starts_with("h_"),
   names_to = "day",
   names_prefix = "h_",
   values_to = "hatch",
   values_drop_na = TRUE)

##nc182
nc182_long = nc182_2 %>%
  pivot_longer(cols = starts_with("h_"),
   names_to = "day",
   names_prefix = "h_",
   values_to = "hatch",
   values_drop_na = TRUE)

##nc126
nc126_long = nc126_2 %>%
  pivot_longer(cols = starts_with("h_"),
   names_to = "day",
   names_prefix = "h_",
   values_to = "hatch",
   values_drop_na = TRUE)

##nc141
nc141_long = nc141_2 %>%
  pivot_longer(cols = starts_with("h_"),
   names_to = "day",
   names_prefix = "h_",
   values_to = "hatch",
   values_drop_na = TRUE)

##nc123
nc123_long = nc123_2 %>%
  pivot_longer(cols = starts_with("h_"),
   names_to = "day",
   names_prefix = "h_",
   values_to = "hatch",
   values_drop_na = TRUE)

##8a
nc8a_long = nc8a_2 %>%
  pivot_longer(cols = starts_with("h_"),
   names_to = "day",
   names_prefix = "h_",
   values_to = "hatch",
   values_drop_na = TRUE)

```

```{r}
###hatch linear models###
#56i
model1 = glmer(pup_t/e_tot ~ male_geno + day + (1|replicate) + (1|vial), family=binomial, weights=e_tot, data=nc110_long)
summary(model1)
model2 = glmer(pup_t/e_tot ~ day + (1|replicate) + (1|vial), family=binomial, weights=e_tot, data=nc110_long)
summary(model2)
anova(model2, model1)

#51a
model1 = glmer(pup_t/e_tot ~ male_geno + day + (1|replicate) + (1|vial), family=binomial, weights=e_tot, data=nc182_long)
summary(model1)
model2 = glmer(pup_t/e_tot ~ day + (1|replicate) + (1|vial), family=binomial, weights=e_tot,data=nc182_long)
summary(model2)
anova(model2, model1)

#56e
model1 = glmer(pup_t/e_tot ~ male_geno + day + (1|replicate) + (1|vial), family=binomial, weights=e_tot, data=nc126_long)
summary(model1)
model2 = glmer(pup_t/e_tot ~ day + (1|replicate) + (1|vial), family=binomial, weights=e_tot, data=nc126_long)
summary(model2)
anova(model2, model1)

#22a
model1 = glmer(pup_t/e_tot ~ male_geno + day + (1|replicate) + (1|vial), family=binomial, weights=e_tot, data=nc141_long)
summary(model1)
model2 = glmer(pup_t/e_tot ~ day + (1|replicate) + (1|vial), family=binomial, weights=e_tot, data=nc141_long)
summary(model2)
anova(model2, model1)

#56f
model1 = glmer(pup_t/e_tot ~ male_geno + day + (1|replicate) + (1|vial), family=binomial, weights = e_tot, data=nc123_long)
summary(model1)
model2 = glmer(pup_t/e_tot ~ day + (1|replicate) + (1|vial), family=binomial, weights=e_tot, data=nc123_long)
summary(model2)
anova(model2, model1)

#8a
model1 = glmer(pup_t/e_tot ~ male_geno + day + (1|replicate) + (1|vial), family=binomial, weights=e_tot, data=nc8a_long)
summary(model1)
model2 = glmer(pup_t/e_tot ~ day + (1|replicate) + (1|vial), family=binomial, weights=e_tot, data=nc8a_long)
summary(model2)
anova(model2, model1)

##hatch p val correction
p=c(0.711, 0.142, 0.191, 0.399, 0.982, 2.4e10-07)
p.adjust(p, "BH", 6)
```

##CRISPR mating assays (+/+, +/-, -/- comparison)
Definition of variables:
vial: vial CS female is put into
male_geno: genotype of male CS female is mated to, for each gene (NC# alone = homozygous mutant, NC#/175 = heterozygote, NC175 = homozygous +). NC# refers to the fly line for these genes: 
NC110 = obp56i
NC182 = obp51a
NC126 = obp56e
NC141 = obp22a
NC123 = obp56f
intro: time male introduced to vial
start: time flies began copulating
done: time flies finished copulating
lat: latency to mate, calculated as start-intro 
dur: duration of mating, calculated as done-start
d_1 through d_4: number of eggs female laid on days 1-4
e_tot: sum of eggs in d_1 through d_4
mated_4: Y/N if that female mated with a CS male on the fourth day after mating within a one hour time frame
set: one of four experimental blocks flies were assayed in (for most genes, x1 was rep1 and x2 was rep2, except nc123 which was split differently across the blocks)
rep: replicate of experiment

```{r}
#load data
crispr_het = read.csv("~/crisprhets_combined.csv")

#subset data by set
a1a2 = subset(crispr_het, crispr_het$set == "A1" | set=="A2")
a1b1 = subset(crispr_het, crispr_het$set == "A1" | set=="B1")
b1b2 = subset(crispr_het, crispr_het$set == "B1" | set=="B2")

#and now pull out the male genotypes we want to compare from there: 
nc110 = subset(a1a2, a1a2$male_geno == "NC110" | male_geno == "NC110/175" | male_geno == "NC175")
nc123 = subset(a1b1, a1b1$male_geno == "NC123" | male_geno == "NC123/175" | male_geno == "NC175")
nc141 = subset(a1a2, a1a2$male_geno == "NC141" | male_geno == "NC141/175" | male_geno == "NC175")
nc126 = subset(b1b2, b1b2$male_geno == "NC126" | male_geno == "NC126/175" | male_geno == "NC175")
nc182 = subset(b1b2, b1b2$male_geno == "NC182" | male_geno == "NC182/175" | male_geno == "NC175")

#change rep in nc123 if set is b1, rep should equal 2 and not 1. nc123 was split across sets in a different way than the other genes but was tested in the same manner.
nc123$rep <- ifelse(nc123$set %in% c('B1'), 2, nc123$rep)

#change male_geno to factor
nc110$male_geno = as.factor(nc110$male_geno)
nc182$male_geno = as.factor(nc182$male_geno)
nc123$male_geno = as.factor(nc123$male_geno)
nc141$male_geno = as.factor(nc141$male_geno)
nc126$male_geno = as.factor(nc126$male_geno)
```

```{r}
###plots
#56i
pa = ggplot(data = nc110,
            aes(x=factor(male_geno, levels=c("NC175", "NC110/175", "NC110")), y=e_tot, fill=male_geno)) + 
  geom_boxplot(position=position_dodge(0.8)) + 
  geom_dotplot(binaxis='y', stackdir='center', dotsize=0.3, position=position_dodge(0.8), fill="black") + 
  labs(x="Male Genotype", y="Eggs Laid (total") + 
  scale_fill_manual(values=c("#FACCC6", "#EF5743", "#CD2913")) +
  theme(axis.text.x = element_text(angle=45, hjust=1)) + 
  theme(legend.position = "none") + 
  theme(panel.background = element_rect(fill="white", colour="grey"))

#56f
pb = ggplot(data = nc123,
            aes(x=factor(male_geno, levels=c("NC175", "NC123/175", "NC123")), y=e_tot, fill=male_geno)) + 
  geom_boxplot(position=position_dodge(0.8)) + 
  geom_dotplot(binaxis='y', stackdir='center', dotsize=0.3, position=position_dodge(0.8), fill="black") + 
  labs(x="Male Genotype", y="Eggs Laid (total") + 
  ylim(0, 400) + 
  scale_fill_manual(values=c("#EAEFBD", "#C9E3AC", "#90BE6D")) +
  theme(axis.text.x = element_text(angle=45, hjust=1)) + 
  theme(legend.position = "none") + 
  theme(panel.background = element_rect(fill="white", colour="grey"))

#22a
pc = ggplot(data = nc141,
            aes(x=factor(male_geno, levels=c("NC175", "NC141/175", "NC141")), y=e_tot, fill=male_geno)) + 
  geom_boxplot(position=position_dodge(0.8)) + 
  geom_dotplot(binaxis='y', stackdir='center', dotsize=0.3, position=position_dodge(0.8), fill="black") + 
  labs(x="Male Genotype", y="Eggs Laid (total") + 
  scale_fill_manual(values=c("#FDC5F5", "#F7AEF8", "#B388EB")) +
  theme(axis.text.x = element_text(angle=45, hjust=1)) + 
  theme(legend.position = "none") + 
  theme(panel.background = element_rect(fill="white", colour="grey"))

#56e
pd = ggplot(data = nc126,
            aes(x=factor(male_geno, levels=c("NC175", "NC126/175", "NC126")), y=e_tot, fill=male_geno)) + 
  geom_boxplot(position=position_dodge(0.8)) + 
  geom_dotplot(binaxis='y', stackdir='center', dotsize=0.3, position=position_dodge(0.8), fill="black") + 
  labs(x="Male Genotype", y="Eggs Laid (total") + 
  scale_fill_manual(values=c("#B6CEF6", "#6F9CEB", "#2D649F")) +
  theme(axis.text.x = element_text(angle=45, hjust=1)) + 
  theme(legend.position = "none") + 
  theme(panel.background = element_rect(fill="white", colour="grey"))

#51a
pe = ggplot(data = nc182,
            aes(x=factor(male_geno, levels=c("NC175", "NC182/175", "NC182")), y=e_tot, fill=male_geno)) + 
  geom_boxplot(position=position_dodge(0.8)) + 
  geom_dotplot(binaxis='y', stackdir='center', dotsize=0.3, position=position_dodge(0.8), fill="black") + 
  labs(x="Male Genotype", y="Eggs Laid (total") + 
  scale_fill_manual(values=c("#40798C", "#CFD7C7", "#70A9A1")) +
  theme(axis.text.x = element_text(angle=45, hjust=1)) + 
  theme(legend.position = "none") + 
  theme(panel.background = element_rect(fill="white", colour="grey"))

figure <- ggarrange(pa, pb, pc, pd, pe,
                    labels = c("A", "B", "C", "D", "E"),
                    ncol = 3, nrow = 2)
figure
```

```{r}
##latency/duration plots
#56i
dur2 = 60*24*(as.numeric(times(nc110$dur)))
nc110 = cbind(nc110, dur2)

lat2 = 60*24*(as.numeric(times(nc110$lat)))
nc110 = cbind(nc110, lat2)

pa1 = ggplot(data = nc110,
            aes(x=factor(male_geno, levels=c("NC175", "NC110/175", "NC110")), y=dur2, fill=male_geno)) + 
  geom_boxplot(position=position_dodge(0.8)) + 
  geom_dotplot(binaxis='y', stackdir='center', dotsize=0.3, position=position_dodge(0.8), fill="black") + 
  labs(x="Male Genotype", y="duration") + 
  scale_fill_manual(values=c("#FACCC6", "#EF5743", "#CD2913")) +
  theme(axis.text.x = element_text(angle=45, hjust=1)) + 
  theme(legend.position = "none") + 
  theme(panel.background = element_rect(fill="white", colour="grey"))

pa2 = ggplot(data = nc110,
            aes(x=factor(male_geno, levels=c("NC175", "NC110/175", "NC110")), y=lat2, fill=male_geno)) + 
  geom_boxplot(position=position_dodge(0.8)) + 
  geom_dotplot(binaxis='y', stackdir='center', dotsize=0.3, position=position_dodge(0.8), fill="black") + 
  labs(x="Male Genotype", y="latency") + 
  scale_fill_manual(values=c("#FACCC6", "#EF5743", "#CD2913")) +
  theme(axis.text.x = element_text(angle=45, hjust=1)) + 
  theme(legend.position = "none") + 
  theme(panel.background = element_rect(fill="white", colour="grey"))

##56f
dur2 = 60*24*(as.numeric(times(nc123$dur)))
nc123 = cbind(nc123, dur2)

lat2 = 60*24*(as.numeric(times(nc123$lat)))
nc123 = cbind(nc123, lat2)

pb1 = ggplot(data = nc123,
            aes(x=factor(male_geno, levels=c("NC175", "NC123/175", "NC123")), y=dur2, fill=male_geno)) + 
  geom_boxplot(position=position_dodge(0.8)) + 
  geom_dotplot(binaxis='y', stackdir='center', dotsize=0.3, position=position_dodge(0.8), fill="black") + 
  labs(x="Male Genotype", y="duration") + 
  scale_fill_manual(values=c("#EAEFBD", "#C9E3AC", "#90BE6D")) +
  theme(axis.text.x = element_text(angle=45, hjust=1)) + 
  theme(legend.position = "none") + 
  theme(panel.background = element_rect(fill="white", colour="grey"))

pb2 = ggplot(data = nc123,
            aes(x=factor(male_geno, levels=c("NC175", "NC123/175", "NC123")), y=lat2, fill=male_geno)) + 
  geom_boxplot(position=position_dodge(0.8)) + 
  geom_dotplot(binaxis='y', stackdir='center', dotsize=0.3, position=position_dodge(0.8), fill="black") + 
  labs(x="Male Genotype", y="latency") + 
  scale_fill_manual(values=c("#EAEFBD", "#C9E3AC", "#90BE6D")) +
  theme(axis.text.x = element_text(angle=45, hjust=1)) + 
  theme(legend.position = "none") + 
  theme(panel.background = element_rect(fill="white", colour="grey"))

##56e
dur2 = 60*24*(as.numeric(times(nc126$dur)))
nc126 = cbind(nc126, dur2)

lat2 = 60*24*(as.numeric(times(nc126$lat)))
nc126 = cbind(nc126, lat2)

pc1 = ggplot(data = nc126,
            aes(x=factor(male_geno, levels=c("NC175", "NC126/175", "NC126")), y=dur2, fill=male_geno)) + 
  geom_boxplot(position=position_dodge(0.8)) + 
  geom_dotplot(binaxis='y', stackdir='center', dotsize=0.3, position=position_dodge(0.8), fill="black") + 
  labs(x="Male Genotype", y="duration") + 
  scale_fill_manual(values=c("#B6CEF6", "#6F9CEB", "#2D649F")) +
  theme(axis.text.x = element_text(angle=45, hjust=1)) + 
  theme(legend.position = "none") + 
  theme(panel.background = element_rect(fill="white", colour="grey"))

pc2 = ggplot(data = nc126,
            aes(x=factor(male_geno, levels=c("NC175", "NC126/175", "NC126")), y=lat2, fill=male_geno)) + 
  geom_boxplot(position=position_dodge(0.8)) + 
  geom_dotplot(binaxis='y', stackdir='center', dotsize=0.3, position=position_dodge(0.8), fill="black") + 
  labs(x="Male Genotype", y="latency") + 
  scale_fill_manual(values=c("#B6CEF6", "#6F9CEB", "#2D649F")) +
  theme(axis.text.x = element_text(angle=45, hjust=1)) + 
  theme(legend.position = "none") + 
  theme(panel.background = element_rect(fill="white", colour="grey"))

##22a
dur2 = 60*24*(as.numeric(times(nc141$dur)))
nc141 = cbind(nc141, dur2)

lat2 = 60*24*(as.numeric(times(nc141$lat)))
nc141 = cbind(nc141, lat2)

pd1 = ggplot(data = nc141,
            aes(x=factor(male_geno, levels=c("NC175", "NC141/175", "NC141")), y=dur2, fill=male_geno)) + 
  geom_boxplot(position=position_dodge(0.8)) + 
  geom_dotplot(binaxis='y', stackdir='center', dotsize=0.3, position=position_dodge(0.8), fill="black") + 
  labs(x="Male Genotype", y="duration") + 
  scale_fill_manual(values=c("#FDC5F5", "#F7AEF8", "#B388EB")) +
  theme(axis.text.x = element_text(angle=45, hjust=1)) + 
  theme(legend.position = "none") + 
  theme(panel.background = element_rect(fill="white", colour="grey"))

pd2 = ggplot(data = nc141,
            aes(x=factor(male_geno, levels=c("NC175", "NC141/175", "NC141")), y=lat2, fill=male_geno)) + 
  geom_boxplot(position=position_dodge(0.8)) + 
  geom_dotplot(binaxis='y', stackdir='center', dotsize=0.3, position=position_dodge(0.8), fill="black") + 
  labs(x="Male Genotype", y="latency") + 
  scale_fill_manual(values=c("#FDC5F5", "#F7AEF8", "#B388EB")) +
  theme(axis.text.x = element_text(angle=45, hjust=1)) + 
  theme(legend.position = "none") + 
  theme(panel.background = element_rect(fill="white", colour="grey"))

##51a
dur2 = 60*24*(as.numeric(times(nc182$dur)))
nc182 = cbind(nc182, dur2)

lat2 = 60*24*(as.numeric(times(nc182$lat)))
nc182 = cbind(nc182, lat2)

pe1 = ggplot(data = nc182,
            aes(x=factor(male_geno, levels=c("NC175", "NC182/175", "NC182")), y=dur2, fill=male_geno)) + 
  geom_boxplot(position=position_dodge(0.8)) + 
  geom_dotplot(binaxis='y', stackdir='center', dotsize=0.3, position=position_dodge(0.8), fill="black") + 
  labs(x="Male Genotype", y="duration") + 
  scale_fill_manual(values=c("#40798C", "#CFD7C7", "#70A9A1")) +
  theme(axis.text.x = element_text(angle=45, hjust=1)) + 
  theme(legend.position = "none") + 
  theme(panel.background = element_rect(fill="white", colour="grey"))

pe2 = ggplot(data = nc182,
            aes(x=factor(male_geno, levels=c("NC175", "NC182/175", "NC182")), y=lat2, fill=male_geno)) + 
  geom_boxplot(position=position_dodge(0.8)) + 
  geom_dotplot(binaxis='y', stackdir='center', dotsize=0.3, position=position_dodge(0.8), fill="black") + 
  labs(x="Male Genotype", y="latency") + 
  scale_fill_manual(values=c("#40798C", "#CFD7C7", "#70A9A1")) +
  theme(axis.text.x = element_text(angle=45, hjust=1)) + 
  theme(legend.position = "none") + 
  theme(panel.background = element_rect(fill="white", colour="grey"))

##duration plot combined
figure <- ggarrange(pa1, pb1, pc1, pd1, pe1,
                    labels = c("A", "B", "C", "D", "E"),
                    ncol = 3, nrow = 2)
figure

##latency plot combined
figure <- ggarrange(pa2, pb2, pc2, pd2, pe2,
                    labels = c("A", "B", "C", "D", "E"),
                    ncol = 3, nrow = 2)
figure
```

```{r}
##remating plot
#the remating data is in the large dataframe above as well, here is a different form (counts)
rematingdat = read.csv("~/crisprhet_rematingrates.csv")

rematingdat$male_geno = factor(rematingdat$male_geno, levels=c("hom_wt", "het", "hom_mut"))

p = ggplot(rematingdat, aes(y=number, x=male_geno, fill=recep)) + 
  geom_bar(position="fill", stat="identity") + 
  facet_wrap(~gene, scales="free_x") + 
  labs(x="Male Genotype", y="Proportion of Females", fill="Remated?") + 
  theme_classic() + 
  theme(panel.spacing = unit(1, "lines")) + 
  theme(strip.text.x = element_text(colour="black")) + 
  theme(strip.background = element_blank()) 

```


```{r}
#egg linear model
#get data into long form 
nc110_long = nc110 %>%
  pivot_longer(cols = starts_with("d_"),
               names_to = "day", 
               values_to = "eggs", 
               values_drop_na = TRUE)

nc123_long = nc123 %>%
  pivot_longer(cols = starts_with("d_"),
               names_to = "day", 
               values_to = "eggs", 
               values_drop_na = TRUE)

nc141_long = nc141 %>%
  pivot_longer(cols = starts_with("d_"),
               names_to = "day", 
               values_to = "eggs", 
               values_drop_na = TRUE)

nc126_long = nc126 %>%
  pivot_longer(cols = starts_with("d_"),
               names_to = "day", 
               values_to = "eggs", 
               values_drop_na = TRUE)

nc182_long = nc182 %>%
  pivot_longer(cols = starts_with("d_"),
               names_to = "day", 
               values_to = "eggs", 
               values_drop_na = TRUE)
```

```{r}
#linear models
#56i
nc110_long$day = as.factor(nc110_long$day)
model3 = glmer(eggs ~ male_geno + day + (1|rep) + (1|vial), family=poisson, data=nc110_long)
summary(model3)
model4 = glmer(eggs ~ day + (1|rep) + (1|vial), family = poisson, data=nc110_long)
summary(model4)
anova(model3, model4)
emmeans(model3, list(pairwise~male_geno))

#56e
nc126_long$day = as.factor(nc126_long$day)
model3 = glmer(eggs ~ male_geno + day + (1|rep) + (1|vial), family=poisson, data=nc126_long)
summary(model3)
model4 = glmer(eggs ~ day + (1|rep) + (1|vial), family = poisson, data=nc126_long)
summary(model4)
anova(model3, model4)
emmeans(model3, list(pairwise~male_geno))

#22a
nc141_long$day = as.factor(nc141_long$day)
model3 = glmer(eggs ~ male_geno + day + (1|rep) + (1|vial), family=poisson, data=nc141_long)
summary(model3)
model4 = glmer(eggs ~ day + (1|rep) + (1|vial), family = poisson, data=nc141_long)
summary(model4)
anova(model3, model4)
emmeans(model3, list(pairwise~male_geno))

#56f
nc123_long$day = as.factor(nc123_long$day)
model3 = glmer(eggs ~ male_geno + day + (1|rep) + (1|vial), family=poisson, data=nc123_long)
summary(model3)
model4 = glmer(eggs ~ day + (1|rep) + (1|vial), family = poisson, data=nc123_long)
summary(model4)
anova(model3, model4)
emmeans(model3, list(pairwise~male_geno))

#51a
nc182_long$day = as.factor(nc182_long$day)
model3 = glmer(eggs ~ male_geno + day + (1|rep) + (1|vial), family=poisson, data=nc182_long)
summary(model3)
model4 = glmer(eggs ~ day + (1|rep) + (1|vial), family = poisson, data=nc182_long)
summary(model4)
anova(model3, model4)
emmeans(model3, list(pairwise~male_geno))
```

```{r}
#latency duration linear models
#56i
model3 = lmer(dur2~male_geno+(1|rep), data=nc110)
summary(model3)
model4 = lmer(dur2~(1|rep), data=nc110)
anova(model3, model4)
emmeans(model3, list(pairwise ~ male_geno), adjust = "BH")

model3 = lmer(lat2~male_geno+(1|rep), data=nc110)
summary(model3)
model4 = lmer(lat2~(1|rep), data=nc110)
anova(model3, model4)
emmeans(model3, list(pairwise ~ male_geno), adjust = "BH")

#56f
model3 = lmer(dur2~male_geno+(1|rep), data=nc123)
summary(model3)
model4 = lmer(dur2~(1|rep), data=nc123)
anova(model3, model4)
emmeans(model3, list(pairwise ~ male_geno), adjust = "BH")

model3 = lmer(lat2~male_geno+(1|rep), data=nc123)
summary(model3)
model4 = lmer(lat2~(1|rep), data=nc123)
anova(model3, model4)
emmeans(model3, list(pairwise ~ male_geno), adjust = "BH")

#56e
model3 = lmer(dur2~male_geno+(1|rep), data=nc126)
summary(model3)
model4 = lmer(dur2~(1|rep), data=nc126)
anova(model3, model4)
emmeans(model3, list(pairwise ~ male_geno), adjust = "BH")

model3 = lmer(lat2~male_geno+(1|rep), data=nc126)
summary(model3)
model4 = lmer(lat2~(1|rep), data=nc126)
anova(model3, model4)
emmeans(model3, list(pairwise ~ male_geno), adjust = "BH")

#22a
model3 = lmer(dur2~male_geno+(1|rep), data=nc141)
summary(model1)
model4 = lmer(dur2~(1|rep), data=nc141)
anova(model3, model4)
emmeans(model3, list(pairwise ~ male_geno), adjust = "BH")

model3 = lmer(lat2~male_geno+(1|rep), data=nc141)
summary(model1)
model4 = lmer(lat2~(1|rep), data=nc141)
anova(model3, model4)
emmeans(model3, list(pairwise ~ male_geno), adjust = "BH")

#51a
model3 = lmer(dur2~male_geno+(1|rep), data=nc182)
summary(model1)
model4 = lmer(dur2~(1|rep), data=nc182)
anova(model3, model4)
emmeans(model3, list(pairwise ~ male_geno), adjust = "BH")

model3 = lmer(lat2~male_geno+(1|rep), data=nc182)
summary(model1)
model4 = lmer(lat2~(1|rep), data=nc182)
anova(model3, model4)
emmeans(model3, list(pairwise ~ male_geno), adjust = "BH")
```

```{r}
##remating
#56i
tab1 = table(nc110$male_geno, nc110$mated_4)
tab1
ptab1 = prop.table(tab1, 2)
ptab1
pairwise_prop_test(tab1)

#56f
tab1 = table(nc123$mated_4, nc123$male_geno)
tab1
ptab1 = prop.table(tab1, 2)
ptab1
pairwise_prop_test(tab1)

#22a
tab1 = table(nc141$mated_4, nc141$male_geno)
tab1
ptab1 = prop.table(tab1, 2)
ptab1
pairwise_prop_test(tab1)

#56e
tab1 = table(nc126$male_geno, nc126$mated_4)
tab1
ptab1 = prop.table(tab1, 2)
ptab1
pairwise_prop_test(tab1)

#51a
tab1 = table(nc182$male_geno, nc182$mated_4)
tab1
ptab1 = prop.table(tab1, 2)
ptab1
pairwise_prop_test(tab1)
```


##Obp56g sperm count and mating plug proportion data (2 reps combined)
Definition of variables (counts):
vial: number of vial female placed in
male_geno: genotype of male CS female mated to. 56g=homozygous obp56g1;protBeGFP; CyO=heterozygous obp56g1/CyO;protBeGFP
freeze_time: time CS female assigned to be frozen post-mating. 3=3 hours, 4=4 days
mated: Y if this pair successfully copulated (Y for all)
frozen: Y if female was successfully frozen in liquid nitrogen (Y for all)
start: time at which flies began copulation
end: time at which flies ended copulation
count: number of GFP sperm in SR and ST (total combined across both types of storage organs)
notes: anything interesting observed during course of experiments

Definition of variables (mp proportions):
vial: number of vial female placed in
male_geno: genotype of male CS female mated to. 56g=homozygous obp56g1;protBeGFP; CyO=heterozygous obp56g1/CyO;protBeGFP
mp: Y/N if a mating plug was observed in the female bursa
sperm: Y/N if a sperm mass was observed in the female bursa
class: factor with 3 levels (A, B, or C). A=Y for mp, Y for sperm; B=N for mp, Y for sperm; C=N no for MP, no for sperm
notes: interesting observations made during the course of the experiments

```{r}
###sperm counts and mp proportion data
#import count data
counts = read.csv("~/56g_spermcounts.csv")

#explicitly order the levels within genotype so the control is first in the graph
counts$male_geno <- factor(counts$male_geno, levels = c("CyO", "56g"))

#make graphs
pal3 <- park_palette("ArcticGates", 2)
plot0 = ggplot(data=count_0, aes(x=male_geno, y=count, fill=male_geno)) +
  geom_boxplot() +
  geom_dotplot(binaxis='y', stackdir = 'center', dotsize=0.45, fill='black')+
  scale_fill_manual(values=pal3) +
  labs(x="Male Genotype", y="Number of sperm")+
  theme_bw()+
  theme(axis.title.y=element_text(size=18), axis.title.x = element_text(size=18), axis.text.y=element_text(size=18), axis.text.x = element_text(size=18), strip.text.x = element_text(size=20)) +
  theme(axis.text.x = element_text(angle=45, hjust=1)) +
  guides(fill=F)

plot3 = ggplot(data=count_3, aes(x=male_geno, y=count, fill=male_geno)) +
  geom_boxplot() +
  geom_dotplot(binaxis='y', stackdir = 'center', dotsize=0.45, fill='black')+
  scale_fill_manual(values=pal3) +
  labs(x="Male Genotype", y="Number of sperm")+
  theme_bw() + 
  ylim(0, 600) +
  theme(axis.title.y=element_text(size=18), axis.title.x = element_text(size=18), axis.text.y=element_text(size=18), axis.text.x = element_text(size=18), strip.text.x = element_text(size=20)) +
  theme(axis.text.x = element_text(angle=45, hjust=1)) +
  guides(fill=F) + 
  theme(panel.background = element_rect(fill="white", colour="grey"))

plot4 = ggplot(data=count_4, aes(x=male_geno, y=count, fill=male_geno)) +
  geom_boxplot() +
  geom_dotplot(binaxis='y', stackdir = 'center', dotsize=0.45, fill='black')+
  scale_fill_manual(values=pal3) +
  labs(x="Male Genotype", y="Number of sperm")+
  theme_bw()+
  ylim(0,600) +
  theme(axis.title.y=element_text(size=18), axis.title.x = element_text(size=18), axis.text.y=element_text(size=18), axis.text.x = element_text(size=18), strip.text.x = element_text(size=20)) +
  theme(axis.text.x = element_text(angle=45, hjust=1)) +
  guides(fill=F)

figure <- ggarrange(plot0, plot3, plot4,
                    ncol = 3, nrow = 1)
figure

#subset the data to separate the freeze times to do the t-tests with
zerohour = subset(sperm_count, sperm_count$freeze_time==0)
threehour = subset(counts, counts$freeze_time == 3)
fourday = subset(counts, counts$freeze_time == 4)

#do t-test
t.test(zerohour$count~zerohour$male_geno)
t.test(threehour$count~threehour$male_geno)
t.test(fourday$count~fourday$male_geno)

#do wilcoxon test as well 
wilcox.test(count ~ male_geno, data=zerohour)
wilcox.test(count ~ male_geno, data = threehour)
wilcox.test(count ~ male_geno, data = fourday)

#import mp proportion data
mp = read.csv("~/56g_mp_proportions.csv")

#explicitly order the levels within genotype so the control is first in the prop.table and the graph
mp$male_geno <- factor(mp$male_geno, levels = c("CyO", "56g"))

#get counts and percentges of class A-C
table1 = table(mp$class, mp$male_geno)
table1
prop_table1 = prop.table(table(mp$class, mp$male_geno), 2)
prop_table1

#transform to percent
prop1 = apply(prop_table1, 2, function(x){x*100})
prop1

#make plot
plot = barplot(prop1, col=c("#537D7F", "#99B7B8", "#F7F6F3"), xlab="Male Genotype", ylim=c(0,100), ylab="Percentage of females") 
plot
```

##obp56g RNAi KD experiments (tub-GAL4)
definition of variables (tubGAL4 counts):
Vial: vial CS female was placed into
Genotype: genotype of male CS female mated to. KD=tubGAL4>obp56gRNAi; WT=w1118>obp56gRNAi
d_1 through d_4: number of eggs each CS female laid on days 1-4
Total: sum of egg laids in d_1 through d_4

definition of variables (tubGAL4 remating):
male_geno: genotype of male CS female mated to. KD=tubGAL4>obp56gRNAi; Control=w1118>obp56gRNAi
recep: y/n if a given female remated with a CS male on the fourth day post-mating within a one hour time frame
number: number of females that fall into each class in recep category

```{r}
#import data
tubkd = read.csv("~/tubgal4_counts.csv")

#get data into "long form" for linear models egg lay
tubkd_long = tubkd %>%
  pivot_longer(cols = starts_with("d_"),
   names_to = "day",
   names_prefix = "d_",
   values_to = "eggs",
   values_drop_na = TRUE)
tubkd_long$day = as.factor(tubkd_long$day)

#make plot
plot = ggplot(data=tubkd_long, 
       aes(x=day, 
           y=eggs, color=Genotype, fill=Genotype)) + 
  geom_dotplot(binaxis='y', stackdir = 'center', dotsize=0.6, position=position_dodge(1), alpha = 0.75) + 
  facet_grid(. ~ Day, scales="free_x", space='free_x', labeller=label_both) +
  labs(x="Day", y="Eggs Laid")+
  theme_classic()+
  expand_limits(x = 1) +
  theme(panel.spacing = unit(1, "lines")) + 
  theme(strip.text.x = element_text(colour = "black")) +
  theme(strip.background = element_blank()) 

p = plot + stat_summary(fun.data=mean_se, fun.args = list(mult=1), 
                 geom="errorbar", position=position_dodge(1), color="gray48", width=0.05, size=0.4) +      stat_summary(fun.y=mean, geom="point", color="gray48", position=position_dodge(1)) + theme(panel.spacing = unit(2, "lines"))

#run linear model 
model1 = glmer(eggs ~ Genotype + day + (1|Vial), family=poisson, data=tubkd_long)
summary(model1)
model2 = glmer(eggs ~ day + (1|Vial), family=poisson, data=tubkd_long)
summary(model2)
anova(model2, model1)

#marginal mean comparison with emmeans
model1=glmer(eggs ~ Genotype*day + (1|Vial), family=poisson, data=tubkd_long)
emmeans(model1, pairwise ~ Genotype | day)

#tubgal4 remating data
tub_remating = read.csv("~/tubgal4_remating.csv")

#make prop.table
table1 = table(tub_remating$mated, tub_remating$male_geno)
table1
prop_table1 = prop.table(table(tub_remating$mated, tub_remating$male_geno), 2)
prop_table1

#transform to percent
prop1 = apply(prop_table1, 2, function(x){x*100})
prop1

fisher.test(table1)

#make plot
plot2 = barplot(prop1, col=c("indianred2", "lightblue"), xlab="Male Genotype", ylim=c(0,100), ylab="Female Remating Rate (%)", legend=rownames(prop1))
plot2
```

##obp56g RNAi experiments (crebA-GAL4)
definition of variables (creb_counts, egg counts):
male_geno: genotype of male CS female mated to. crebw1118=CrebA-GAL4>w1118; creb56g=CrebA-GAL4>obp56gRNAi
vial: vial CS female placed into
d_1 through d_4: number of eggs each female laid from days 1-4 post-mating
egg_tot: sum of eggs from d_1 through d_4
recep: Y/N if that female remated with a CS male 4 days post-mating
rep: replicate of experiment

definition of variables (creb_recep, remating rates)
vial: vial: vial CS female placed into
male_geno: genotype of male CS female mated to. crebw1118=CrebA-GAL4>w1118; creb56g=CrebA-GAL4>obp56gRNAi
remated: Y/N if the CS female remated on the fourth day after mating
rep: replicate of experiment

definition of variables (crebgal4_mp_prop, mating plug proportions):
vial: vial: vial CS female placed into
male_geno: genotype of male CS female mated to. crebw1118=CrebA-GAL4>w1118; creb56g=CrebA-GAL4>obp56gRNAi
mp: Y/N if a mating plug was observed in the female bursa immediately after the end of mating
rep: replicate of experiment

```{r}
###egg lay
#import the data
creb_counts = read.csv("~/crebgal4.csv")

#reorder male_geno so control appears first in the graph
creb_counts$male_geno <- factor(creb_counts$male_geno, levels = c("crebw1118", "creb56g"))

#get data into "long form" for linear models egg lay
creb_counts_long = creb_counts %>%
  pivot_longer(cols = starts_with("d_"),
   names_to = "day",
   names_prefix = "d_",
   values_to = "eggs",
   values_drop_na = TRUE)
creb_counts_long$day = as.factor(creb_counts_long$day)

#make plot
plot = ggplot(data=egg_long, 
       aes(x=male_geno, 
           y=eggs, color=male_geno)) +
  facet_grid(. ~ day) +
  labs(x="Male Genotype", y="Eggs laid (total)")+
  theme_classic()+
  theme(panel.spacing = unit(1, "lines")) + 
  theme(strip.text.x = element_text(colour = "black")) +
  theme(strip.background = element_blank())+
  geom_quasirandom(dodge.width=.9,alpha=.4) 

p = plot + stat_summary(fun.data=mean_se, fun.args=list(mult=1), geom="errorbar", position=position_dodge(1), color="gray48", width=0.3, size=0.6) + stat_summary(fun.y=mean, geom="point", color="gray48", position=position_dodge(1)) 

#linear model
model1 = glmer(eggs ~ male_geno + day + (1|rep) + (1|vial), family=poisson, data=creb_counts_long)
summary(model1)
model2 = glmer(eggs ~ day + (1| rep) + (1|vial), family=poisson, data=creb_counts_long)
summary(model2)
anova(model2, model1)

#emmeans comparison
model1=glmer(eggs~male_geno*day + (1|rep) + (1|vial), family=poisson, data=creb_counts_long)
emmeans(model1, pairwise ~ male_geno | day)

###remating rates
creb_recep=read.csv("~/creb_remating.csv")
creb_recep$male_geno <- factor(creb_recep$male_geno, levels = c("crebw1118", "creb56g"))
#make proportion table to see proportion of females that remated @ 4 days. 
table1 = table(creb_recep$remated, creb_recep$male_geno)
table1
prop_table1 = prop.table(table(creb_recep$remated, creb_recep$male_geno), 2)
prop_table1

#transform to percent
prop1 = apply(prop_table1, 2, function(x){x*100})
prop1

fisher.test(table1)

remating_plot = barplot(prop1, col=c("indianred2", "lightblue"), xlab="Male Genotype", ylim=c(0,100), ylab="Proportion of females", legend=rownames(prop1))

###mp proportions
#import data
crebgal4_mp_prop=read.csv("~/crebgal4_mp.csv")
#reorder male_geno so control appears first in the graph
crebgal4_mp_prop$male_geno <- factor(crebgal4_mp_prop$male_geno, levels = c("crebw1118", "creb56g"))

#make proportion table to see proportion of females with mating plugs in bursa
table1 = table(crebgal4_mp_prop$mp, crebgal4_mp_prop$male_geno)
table1
prop_table1 = prop.table(table(crebgal4_mp_prop$mp, crebgal4_mp_prop$male_geno), 2)
prop_table1

#transform to percent
prop1 = apply(prop_table1, 2, function(x){x*100})
prop1

fisher.test(table1)

mp_plot = barplot(prop1, col=c("indianred2", "lightblue"), xlab="Male Genotype", ylim=c(0,100), ylab="Females with mating plugs in bursa (%)", legend=rownames(prop1))


```

